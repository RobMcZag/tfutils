

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tfutils.tests.test &mdash; TFUtils 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="TFUtils 0.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> TFUtils
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/overview.html#base-train-from-params"><code class="docutils literal"><span class="pre">base.train_from_params</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/overview.html#base-test-from-params"><code class="docutils literal"><span class="pre">base.test_from_params</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/installation.html#id1">Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/getting_started.html#configuring-mongodb">Configuring MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/getting_started.html#specifying-an-experiment">Specifying an Experiment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/getting_started.html#defining-a-model">Defining a Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/getting_started.html#including-validation">Including Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/getting_started.html#train">Train!</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Fundamentals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../fundamentals/multigpu.html">Multi-GPU Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fundamentals/multimodel.html">Multi-Model Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fundamentals/minibatching.html">Minibatching</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">tfutils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html">tfutils.base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html#module-tfutils.data">tfutils.data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html#module-tfutils.error">tfutils.error</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html#module-tfutils.model">tfutils.model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html#module-tfutils.optimizer">tfutils.optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tfutils.html#module-tfutils.utils">tfutils.utils</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TFUtils</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>tfutils.tests.test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tfutils.tests.test</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;tfutils tests.</span>

<span class="sd">These tests show basic procedures for training, validating, and extracting features from</span>
<span class="sd">models.</span>

<span class="sd">Note about MongoDB:</span>
<span class="sd">The tests require a MongoDB instance to be available on the port defined by &quot;testport&quot; in</span>
<span class="sd">the code below.   This db can either be local to where you run these tests (and therefore</span>
<span class="sd">on &#39;localhost&#39; by default) or it can be running somewhere else and then by ssh-tunneled on</span>
<span class="sd">the relevant port to the host where you run these tests.  [That is, before testing, you&#39;d run</span>
<span class="sd">         ssh -f -N -L  [testport]:localhost:[testport] [username]@mongohost.xx.xx</span>
<span class="sd">on the machine where you&#39;re running these tests.   [mongohost] is the where the mongodb</span>
<span class="sd">instance is running.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">gridfs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymongo</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;/home/aandonia/tfutils&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tfutils</span> <span class="k">import</span> <span class="n">base</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">optimizer</span>


<span class="n">num_batches_per_epoch</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">//</span> <span class="mi">256</span>

<span class="n">testhost</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>       <span class="c1"># Host on which the MongoDB instance to be used by tests needs to be running</span>
<span class="n">testport</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TFUTILS_TEST_DBPORT&#39;</span><span class="p">,</span> <span class="mi">29101</span><span class="p">))</span>  <span class="c1"># port on which the MongoDB instance to be used by tests needs to be running</span>
<span class="n">testdbname</span> <span class="o">=</span> <span class="s1">&#39;tfutils-test&#39;</span>  <span class="c1"># name of the mongodb database where results will be stored by tests</span>
<span class="n">testcol</span> <span class="o">=</span> <span class="s1">&#39;testcol&#39;</span>          <span class="c1"># name of the mongodb collection where results will be stored by tests</span>

<span class="n">testcol_dist</span> <span class="o">=</span> <span class="s1">&#39;testcol_dist&#39;</span>
<span class="n">testcol_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol_multi&#39;</span>
<span class="n">testcol_dist_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol_dist_multi&#39;</span>
<span class="n">testcol_cust</span> <span class="o">=</span> <span class="s1">&#39;testcol_cust&#39;</span>
<span class="n">testcol_cust_dist</span> <span class="o">=</span> <span class="s1">&#39;testcol_cust_dist&#39;</span>
<span class="n">testcol_cust_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol_cust_multi&#39;</span>
<span class="n">testcol_cust_dist_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol_cust_dist_multi&#39;</span>

<span class="n">testcol2_dist</span> <span class="o">=</span> <span class="s1">&#39;testcol2_dist&#39;</span>
<span class="n">testcol2_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol2_multi&#39;</span>
<span class="n">testcol2_dist_multi</span> <span class="o">=</span> <span class="s1">&#39;testcol2_dist_multi&#39;</span>


<div class="viewcode-block" id="run_all_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_all_tests">[docs]</a><span class="k">def</span> <span class="nf">run_all_tests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run all tests.</span>

<span class="sd">    This function drops all databases associated/created by the tests in the</span>
<span class="sd">    module before running them.</span>

<span class="sd">    TODO: The order in which these tests are run matters. For example, you must</span>
<span class="sd">    run a training test before its corresponding test/validation test can be</span>
<span class="sd">    run successfully.</span>

<span class="sd">    TODO: The number of times a certain test is run will also affect its</span>
<span class="sd">    outcome (e.g. some of the validation tests, which expect a certain number</span>
<span class="sd">    of entries in the database).</span>

<span class="sd">    TODO: Use unittests module and testCases to perform setUp and tearDown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">remove_dbs</span><span class="p">()</span>
    <span class="n">run_training_tests</span><span class="p">()</span>
    <span class="n">run_custom_training_tests</span><span class="p">()</span>
    <span class="n">run_training_save_tests</span><span class="p">()</span>
    <span class="n">run_validation_tests</span><span class="p">()</span>
    <span class="n">run_feature_extraction_tests</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_training_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_training_tests">[docs]</a><span class="k">def</span> <span class="nf">run_training_tests</span><span class="p">():</span>
    <span class="n">test_training</span><span class="p">()</span>
    <span class="n">test_distributed_training</span><span class="p">()</span>
    <span class="n">test_multimodel_training</span><span class="p">()</span>
    <span class="n">test_distributed_multimodel_training</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_training_save_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_training_save_tests">[docs]</a><span class="k">def</span> <span class="nf">run_training_save_tests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run training save tests.&quot;&quot;&quot;</span>
    <span class="n">test_training_save</span><span class="p">()</span>
    <span class="n">test_distributed_training_save</span><span class="p">()</span>
    <span class="n">test_multimodel_training_save</span><span class="p">()</span>
    <span class="n">test_distributed_multimodel_training_save</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_custom_training_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_custom_training_tests">[docs]</a><span class="k">def</span> <span class="nf">run_custom_training_tests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run custom training tests.&quot;&quot;&quot;</span>
    <span class="n">test_custom_training</span><span class="p">()</span>
    <span class="n">test_custom_distributed_training</span><span class="p">()</span>
    <span class="n">test_custom_multimodel_training</span><span class="p">()</span>
    <span class="n">test_custom_distributed_multimodel_training</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_feature_extraction_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_feature_extraction_tests">[docs]</a><span class="k">def</span> <span class="nf">run_feature_extraction_tests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run feature extraction tests.&quot;&quot;&quot;</span>
    <span class="n">test_feature_extraction</span><span class="p">()</span>
    <span class="n">test_distributed_feature_extraction</span><span class="p">()</span>
    <span class="n">test_multimodel_feature_extraction</span><span class="p">()</span>
    <span class="n">test_distributed_multimodel_feature_extraction</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_validation_tests"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.run_validation_tests">[docs]</a><span class="k">def</span> <span class="nf">run_validation_tests</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run validation tests.&quot;&quot;&quot;</span>
    <span class="n">test_validation</span><span class="p">()</span>
    <span class="n">test_distributed_validation</span><span class="p">()</span>
    <span class="n">test_multimodel_validation</span><span class="p">()</span>
    <span class="n">test_distributed_multimodel_validation</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_training">[docs]</a><span class="k">def</span> <span class="nf">test_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate training.</span>

<span class="sd">    This test illustrates how basic training is performed using the</span>
<span class="sd">    tfutils.base.train_from_params function.  This is the first in a sequence of</span>
<span class="sd">    interconnected tests. It creates a pretrained model that is used by</span>
<span class="sd">    the next few tests (test_validation and test_feature_extraction).</span>

<span class="sd">    As can be seen by looking at how the test checks for correctness, after the</span>
<span class="sd">    training is run, results of training, including (intermittently) the full</span>
<span class="sd">    variables needed to re-initialize the tensorflow model, are stored in a</span>
<span class="sd">    MongoDB.</span>

<span class="sd">    Also see docstring of the tfutils.base.train_from_params function for more detailed</span>
<span class="sd">    information about usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># delete old database if it exists</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                             <span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span>
                              <span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="n">DEBUG</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="c1"># test if results are as expected</span>

    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">26</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run another 500 steps of training on the same experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># test if results are as expected</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">51</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="s1">&#39;tfutils-test&#39;</span><span class="p">][</span><span class="s1">&#39;testcol.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;training0&#39;</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run 500 more steps but save to a new experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;training1&#39;</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training1&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_distributed_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_training">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed training.</span>

<span class="sd">    This test illustrates how basic distributed training is performed using the</span>
<span class="sd">    tfutils.base.train_from_params function.  This runs identically to the test</span>
<span class="sd">    above, although a single model is distributed across the batch dimension</span>
<span class="sd">    over multiple GPUs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                    <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">]}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                   <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                   <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                   <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                   <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                   <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>

    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">26</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run another 500 steps of training on the same experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">51</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;training0&#39;</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run 500 more steps but save to a new experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;training1&#39;</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training1&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_multimodel_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_multimodel_training">[docs]</a><span class="k">def</span> <span class="nf">test_multimodel_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate training with multiple models.</span>

<span class="sd">    This test illustrates how basic multi-model training is performed using the</span>
<span class="sd">    tfutils.base.train_from_params function. This runs identically to the test</span>
<span class="sd">    above, although multiple models on different GPUs share the same dataprovider</span>
<span class="sd">    during training.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                    <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                    <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                    <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                    <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">26</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run another 500 steps of training on the same experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">51</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                                                          <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">))</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run 500 more steps but save to a new experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;training1&#39;</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training1_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_distributed_multimodel_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_multimodel_training">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_multimodel_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed training with multiple models.</span>

<span class="sd">    This test illustrates how distributed, multi-model training is performed</span>
<span class="sd">    using the tfutils.base.train_from_params function. This runs identically</span>
<span class="sd">    to the test above, although multiple models on different GPUs share the</span>
<span class="sd">    same dataprovider during training.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                   <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                   <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                   <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                   <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                   <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">26</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run another 500 steps of training on the same experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">51</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                                                          <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">))</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run 500 more steps but save to a new experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;training1&#39;</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training1_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span></div>


<div class="viewcode-block" id="custom_train_loop"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.custom_train_loop">[docs]</a><span class="k">def</span> <span class="nf">custom_train_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="o">**</span><span class="n">loop_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define Custom training loop.</span>

<span class="sd">    Args:</span>
<span class="sd">        sess (tf.Session): Current tensorflow session.</span>
<span class="sd">        train_targets (list): Description.</span>
<span class="sd">        **loop_params: Optional kwargs needed to perform custom train loop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing train targets evaluated by the session.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calling custom training loop...&#39;</span><span class="p">)</span>
    <span class="n">train_results</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_results</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model </span><span class="si">{}</span><span class="s1"> has loss </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">train_results</span></div>


<div class="viewcode-block" id="test_custom_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_custom_training">[docs]</a><span class="k">def</span> <span class="nf">test_custom_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate training with custom training loop.</span>

<span class="sd">    This test illustrates how basic training is performed using the</span>
<span class="sd">    tfutils.base.train_from_params function.  This is the first in a sequence of</span>
<span class="sd">    interconnected tests. It creates a pretrained model that is used by</span>
<span class="sd">    the next few tests (test_validation and test_feature_extraction).</span>

<span class="sd">    As can be seen by looking at how the test checks for correctness, after the</span>
<span class="sd">    training is run, results of training, including (intermittently) the full variables</span>
<span class="sd">    needed to re-initialize the tensorflow model, are stored in a MongoDB.</span>

<span class="sd">    Also see docstring of the tfutils.base.train_from_params function for more detailed</span>
<span class="sd">    information about usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_cust</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#  everything is list except &#39;train_params&#39;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                             <span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span>
                              <span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># test if results are as expected</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">26</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run another 500 steps of training on the same experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># test if results are as expected</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">51</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;training0&#39;</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run 500 more steps but save to a new experiment id.</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;training1&#39;</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training1&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1400</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_custom_distributed_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_custom_distributed_training">[docs]</a><span class="k">def</span> <span class="nf">test_custom_distributed_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed training with custom training loop.</span>

<span class="sd">    This test illustrates how distributed training is performed with a custom</span>
<span class="sd">    training loop using the tfutils.base.train_from_params function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_cust_dist</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                    <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                    <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                    <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                    <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                    <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                    <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_custom_multimodel_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_custom_multimodel_training">[docs]</a><span class="k">def</span> <span class="nf">test_custom_multimodel_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate multimodel training with custom training loops.</span>

<span class="sd">    This test illustrates how multimodel training is performed with custom</span>
<span class="sd">    training loops using the tfutils.base.train_from_params function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_cust_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>

    <span class="n">train1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                     <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">train2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                     <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                   <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                   <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                   <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                   <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                   <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">train_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">train1_params</span><span class="p">,</span> <span class="n">train2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_custom_distributed_multimodel_training"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_custom_distributed_multimodel_training">[docs]</a><span class="k">def</span> <span class="nf">test_custom_distributed_multimodel_training</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate custom distributed training with multiple models.</span>

<span class="sd">    This test illustrates how distributed, multi-model training is performed</span>
<span class="sd">    with custom training loops using the tfutils.base.train_from_params</span>
<span class="sd">    function. This runs identically to the test above, although multiple</span>
<span class="sd">    models on different GPUs share the same dataprovider during training.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_cust_dist_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>

    <span class="n">save_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                   <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                   <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                   <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                   <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                   <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                   <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

    <span class="n">train1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                     <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">train2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                     <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">custom_train_loop</span><span class="p">},</span>
                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

    <span class="n">loss_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">,</span>
                   <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">}</span>

    <span class="n">learning_rate_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                            <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                            <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">ClipOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                        <span class="s1">&#39;clip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">load_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">train_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">train1_params</span><span class="p">,</span> <span class="n">train2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate_params</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_first_image_target"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.get_first_image_target">[docs]</a><span class="k">def</span> <span class="nf">get_first_image_target</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="o">**</span><span class="n">ttarg_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A target for saving the first image of every batch.</span>

<span class="sd">    Used in test_training test below to test save_to_gfs option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;first_image&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span></div>


<div class="viewcode-block" id="test_training_save"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_training_save">[docs]</a><span class="k">def</span> <span class="nf">test_training_save</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate saving to the grid file system during training time.&quot;&quot;&quot;</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2&#39;</span>
    <span class="n">testcol_2</span> <span class="o">=</span> <span class="s1">&#39;testcol2&#39;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="c1"># delete old collection if it exists</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol_2</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
    <span class="n">coll</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol_2</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;first_image&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                              <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_first_image_target</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that the first image has been saved</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;train_results&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol_2</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
    <span class="n">train_steps</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol_2</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span> <span class="ow">and</span> <span class="s1">&#39;first_image&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,),</span> <span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,))</span></div>


<div class="viewcode-block" id="test_distributed_training_save"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_training_save">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_training_save</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate saving to the grid file system during distributed training.&quot;&quot;&quot;</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2&#39;</span>
    <span class="n">testcol_2</span> <span class="o">=</span> <span class="n">testcol2_dist</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                              <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol_2</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;first_image&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                              <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_first_image_target</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that the first image has been saved</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;train_results&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol_2</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
    <span class="n">train_steps</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol_2</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span> <span class="ow">and</span> <span class="s1">&#39;first_image&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,),</span> <span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,))</span></div>


<div class="viewcode-block" id="test_multimodel_training_save"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_multimodel_training_save">[docs]</a><span class="k">def</span> <span class="nf">test_multimodel_training_save</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate saving to the grid file system during multimodel training.&quot;&quot;&quot;</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2&#39;</span>
    <span class="n">testcol_2</span> <span class="o">=</span> <span class="n">testcol2_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol_2</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;first_image&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                              <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_first_image_target</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># check that the first image has been saved</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;train_results&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol_2</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
        <span class="n">train_steps</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol_2</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span> <span class="ow">and</span> <span class="s1">&#39;first_image&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,),</span> <span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,))</span></div>


<div class="viewcode-block" id="test_distributed_multimodel_training_save"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_multimodel_training_save">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_multimodel_training_save</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate saving to gridFS during distributed multimodel training.&quot;&quot;&quot;</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2&#39;</span>
    <span class="n">testcol_2</span> <span class="o">=</span> <span class="n">testcol2_dist_multi</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># set up the parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                              <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                              <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol_2</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                             <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;first_image&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                              <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_first_image_target</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_steps&#39;</span><span class="p">:</span> <span class="n">num_batches_per_epoch</span><span class="p">,</span>
                                      <span class="s1">&#39;decay_rate&#39;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                                      <span class="s1">&#39;staircase&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># actually run the training</span>
    <span class="n">base</span><span class="o">.</span><span class="n">train_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;training2_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># check that the first image has been saved</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;train_results&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol_2</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
        <span class="n">train_steps</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">train_steps</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">train_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol_2</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span> <span class="ow">and</span> <span class="s1">&#39;first_image&#39;</span> <span class="ow">in</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,),</span> <span class="p">(</span><span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="s1">&#39;first_image&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,))</span></div>


<div class="viewcode-block" id="test_validation"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_validation">[docs]</a><span class="k">def</span> <span class="nf">test_validation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate validation.</span>

<span class="sd">    This is a test illustrating how to compute performance on a trained model on a new dataset,</span>
<span class="sd">    using the tfutils.base.test_from_params function.  This test assumes that test_training function</span>
<span class="sd">    has run first (to provide a pre-trained model to validate).</span>

<span class="sd">    After the test is run, results from the validation are stored in the MongoDB.</span>
<span class="sd">    (The test shows how the record can be loaded for inspection.)</span>

<span class="sd">    See the docstring of tfutils.base.test_from_params for more detailed information on usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># specify the parameters for the validation</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># check that the results are correct</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})</span>

    <span class="c1"># actually run the model</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># ... specifically, there is now a record containing the validation0 performance results</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="c1"># ... here&#39;s how to load the record:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ... check that the recorrectly ties to the id information for the</span>
    <span class="c1"># pre-trained model it was supposed to validate</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
    <span class="n">idval</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">idval</span> <span class="o">==</span> <span class="n">v</span></div>


<div class="viewcode-block" id="test_distributed_validation"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_validation">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_validation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed validation.</span>

<span class="sd">    This is a test illustrating how to compute performance on a trained model on a new dataset,</span>
<span class="sd">    using the tfutils.base.test_from_params function.  This test assumes that test_training function</span>
<span class="sd">    has run first (to provide a pre-trained model to validate).</span>

<span class="sd">    After the test is run, results from the validation are stored in the MongoDB.</span>
<span class="sd">    (The test shows how the record can be loaded for inspection.)</span>

<span class="sd">    See the docstring of tfutils.base.test_from_params for more detailed information on usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist</span>

    <span class="c1"># specify the parameters for the validation</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                    <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>

    <span class="c1"># actually run the model</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that the results are correct</span>

    <span class="c1"># ... specifically, there is now a record containing the validation0 performance results</span>
    <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="c1"># ... here&#39;s how to load the record:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ... check that the recorrectly ties to the id information for the</span>
    <span class="c1"># pre-trained model it was supposed to validate</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
    <span class="n">idval</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">})[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">idval</span> <span class="o">==</span> <span class="n">v</span></div>


<div class="viewcode-block" id="test_multimodel_validation"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_multimodel_validation">[docs]</a><span class="k">def</span> <span class="nf">test_multimodel_validation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate multimodel validation.</span>

<span class="sd">    This is a test illustrating how to compute performance on a trained model on a new dataset,</span>
<span class="sd">    using the tfutils.base.test_from_params function.  This test assumes that test_training function</span>
<span class="sd">    has run first (to provide a pre-trained model to validate).</span>

<span class="sd">    After the test is run, results from the validation are stored in the MongoDB.</span>
<span class="sd">    (The test shows how the record can be loaded for inspection.)</span>

<span class="sd">    See the docstring of tfutils.base.test_from_params for more detailed information on usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_multi</span>

    <span class="c1"># specify the parameters for the validation</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the model</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that the results are correct</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">train_exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># ... specifically, there is now a record containing the validation0 performance results</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># ... here&#39;s how to load the record:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ... check that the recorrectly ties to the id information for the</span>
        <span class="c1"># pre-trained model it was supposed to validate</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">train_exp_id</span><span class="p">})[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">idval</span> <span class="o">==</span> <span class="n">v</span></div>


<div class="viewcode-block" id="test_distributed_multimodel_validation"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_multimodel_validation">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_multimodel_validation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed multimodel validation.</span>

<span class="sd">    This is a test illustrating how to compute performance on a trained model on a new dataset,</span>
<span class="sd">    using the tfutils.base.test_from_params function.  This test assumes that test_training function</span>
<span class="sd">    has run first (to provide a pre-trained model to validate).</span>

<span class="sd">    After the test is run, results from the validation are stored in the MongoDB.</span>
<span class="sd">    (The test shows how the record can be loaded for inspection.)</span>

<span class="sd">    See the docstring of tfutils.base.test_from_params for more detailed information on usage.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist_multi</span>

    <span class="c1"># specify the parameters for the validation</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">]}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:2&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:3&#39;</span><span class="p">]}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;validation0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid0&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the model</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that the results are correct</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">train_exp_id</span> <span class="o">=</span> <span class="s1">&#39;training0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># ... specifically, there is now a record containing the validation0 performance results</span>
        <span class="k">assert</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># ... here&#39;s how to load the record:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ... check that the recorrectly ties to the id information for the</span>
        <span class="c1"># pre-trained model it was supposed to validate</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">train_exp_id</span><span class="p">})[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">idval</span> <span class="o">==</span> <span class="n">v</span></div>


<div class="viewcode-block" id="get_extraction_target"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.get_extraction_target">[docs]</a><span class="k">def</span> <span class="nf">get_extraction_target</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">to_extract</span><span class="p">,</span> <span class="o">**</span><span class="n">loss_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Produce validation target function.</span>

<span class="sd">    Example validation target function to use to provide targets for extracting features.</span>
<span class="sd">    This function also adds a standard &quot;loss&quot; target which you may or not may not want</span>

<span class="sd">    The to_extract argument must be a dictionary of the form</span>
<span class="sd">          {name_for_saving: name_of_actual_tensor, ...}</span>
<span class="sd">    where the &quot;name_for_saving&quot; is a human-friendly name you want to save extracted</span>
<span class="sd">    features under, and name_of_actual_tensor is a name of the tensor in the tensorflow</span>
<span class="sd">    graph outputing the features desired to be extracted.  To figure out what the names</span>
<span class="sd">    of the tensors you want to extract are &quot;to_extract&quot; argument,  uncomment the</span>
<span class="sd">    commented-out lines, which will print a list of all available tensor names.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;__GPU__\d/&#39;</span><span class="p">)</span>
    <span class="n">_targets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">name_without_gpu_prefix</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">save_name</span><span class="p">,</span> <span class="n">actual_name</span> <span class="ow">in</span> <span class="n">to_extract</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">actual_name</span> <span class="ow">in</span> <span class="n">name_without_gpu_prefix</span><span class="p">:</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">_targets</span><span class="p">[</span><span class="n">save_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">targets</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="o">**</span><span class="n">loss_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">targets</span></div>


<div class="viewcode-block" id="test_feature_extraction"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_feature_extraction">[docs]</a><span class="k">def</span> <span class="nf">test_feature_extraction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate feature extraction.</span>

<span class="sd">    This is a test illustrating how to perform feature extraction using</span>
<span class="sd">    tfutils.base.test_from_params.</span>
<span class="sd">    The basic idea is to specify a validation target that is simply the actual output of</span>
<span class="sd">    the model at some layer. (See the &quot;get_extraction_target&quot; function above as well.)</span>
<span class="sd">    This test assumes that test_train has run first.</span>

<span class="sd">    After the test is run, the results of the feature extraction are saved in the Grid</span>
<span class="sd">    File System associated with the mongo database, with one file per batch of feature</span>
<span class="sd">    results.  See how the features are accessed by reading the test code below.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up parameters</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1&#39;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;more_features&#39;</span><span class="p">]}</span>

    <span class="n">targdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                              <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                              <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                              <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                              <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                              <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict</span><span class="p">,</span>
                                              <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                              <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the feature extraction</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that things are as expected.</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">11</span>

    <span class="c1"># ... load the containing the final &quot;aggregate&quot; result after all features have been extracted</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
    <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># ... check that the record is well-formed</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ... check that the correct &quot;intermediate results&quot; (the actual features extracted) records exist</span>
    <span class="c1"># and are correctly referenced.</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ids</span>

    <span class="c1"># ... actually load feature batch 3</span>
    <span class="n">idval</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idval</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">first_results</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s1">&#39;features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span> <span class="ow">and</span> <span class="s1">&#39;more_features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
    <span class="n">more_features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;more_features&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span></div>


<div class="viewcode-block" id="test_distributed_feature_extraction"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_feature_extraction">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_feature_extraction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed feature extraction.</span>

<span class="sd">    This is a test illustrating how to perform feature extraction with a</span>
<span class="sd">    distributed model using tfutils.base.test_from_params.</span>

<span class="sd">    The basic idea is to specify a validation target that is simply the actual output of</span>
<span class="sd">    the model at some layer. (See the &quot;get_extraction_target&quot; function above as well.)</span>
<span class="sd">    This test assumes that test_train has run first.</span>

<span class="sd">    After the test is run, the results of the feature extraction are saved in the Grid</span>
<span class="sd">    File System associated with the mongo database, with one file per batch of feature</span>
<span class="sd">    results.  See how the features are accessed by reading the test code below.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up parameters</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1&#39;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                    <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">]}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;more_features&#39;</span><span class="p">]}</span>

    <span class="n">targdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>

    <span class="n">validation_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                    <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                    <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict</span><span class="p">,</span>
                                    <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_params</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the feature extraction</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that things are as expected.</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">11</span>

    <span class="c1"># ... load the containing the final &quot;aggregate&quot; result after all features have been extracted</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
    <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># ... check that the record is well-formed</span>
    <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># ... check that the correct &quot;intermediate results&quot; (the actual features extracted) records exist</span>
    <span class="c1"># and are correctly referenced.</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ids</span>

    <span class="c1"># ... actually load feature batch 3</span>
    <span class="n">idval</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idval</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol</span><span class="p">)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">first_results</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s1">&#39;features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span> <span class="ow">and</span> <span class="s1">&#39;more_features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
    <span class="n">more_features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;more_features&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span></div>


<div class="viewcode-block" id="test_multimodel_feature_extraction"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_multimodel_feature_extraction">[docs]</a><span class="k">def</span> <span class="nf">test_multimodel_feature_extraction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate multimodel feature extraction.</span>

<span class="sd">    This is a test illustrating how to perform feature extraction with a</span>
<span class="sd">    distributed model using tfutils.base.test_from_params.</span>

<span class="sd">    The basic idea is to specify a validation target that is simply the actual output of</span>
<span class="sd">    the model at some layer. (See the &quot;get_extraction_target&quot; function above as well.)</span>
<span class="sd">    This test assumes that test_train has run first.</span>

<span class="sd">    After the test is run, the results of the feature extraction are saved in the Grid</span>
<span class="sd">    File System associated with the mongo database, with one file per batch of feature</span>
<span class="sd">    results.  See how the features are accessed by reading the test code below.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up parameters</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_multi</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1&#39;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;more_features&#39;</span><span class="p">]}</span>

    <span class="n">targdict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                 <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                 <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_1/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_1/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>
    <span class="n">targdict2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>

    <span class="n">validation_params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                     <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict1</span><span class="p">,</span>
                                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                     <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>

    <span class="n">validation_params2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                     <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict2</span><span class="p">,</span>
                                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                     <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">validation_params1</span><span class="p">,</span> <span class="n">validation_params2</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;skip_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the feature extraction</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that things are as expected.</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">11</span>

        <span class="c1"># ... load the containing the final &quot;aggregate&quot; result after all features have been extracted</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
        <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># ... check that the record is well-formed</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ... check that the correct &quot;intermediate results&quot; (the actual features extracted) records exist</span>
        <span class="c1"># and are correctly referenced.</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ids</span>

        <span class="c1"># ... actually load feature batch 3</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idval</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">first_results</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s1">&#39;features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span> <span class="ow">and</span> <span class="s1">&#39;more_features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
        <span class="n">more_features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;more_features&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span></div>


<div class="viewcode-block" id="test_distributed_multimodel_feature_extraction"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.test_distributed_multimodel_feature_extraction">[docs]</a><span class="k">def</span> <span class="nf">test_distributed_multimodel_feature_extraction</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Illustrate distributed multimodel feature extraction.</span>

<span class="sd">    This is a test illustrating how to perform feature extraction with a</span>
<span class="sd">    distributed model using tfutils.base.test_from_params.</span>

<span class="sd">    The basic idea is to specify a validation target that is simply the actual output of</span>
<span class="sd">    the model at some layer. (See the &quot;get_extraction_target&quot; function above as well.)</span>
<span class="sd">    This test assumes that test_train has run first.</span>

<span class="sd">    After the test is run, the results of the feature extraction are saved in the Grid</span>
<span class="sd">    File System associated with the mongo database, with one file per batch of feature</span>
<span class="sd">    results.  See how the features are accessed by reading the test code below.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up parameters</span>
    <span class="n">testcol</span> <span class="o">=</span> <span class="n">testcol_dist_multi</span>
    <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1&#39;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model1_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">]}</span>
    <span class="n">model2_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">mnist_tfutils</span><span class="p">,</span>
                     <span class="s1">&#39;devices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/gpu:2&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:3&#39;</span><span class="p">]}</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model1_params</span><span class="p">,</span> <span class="n">model2_params</span><span class="p">]</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">testhost</span><span class="p">,</span>
                             <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">testport</span><span class="p">,</span>
                             <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="n">testdbname</span><span class="p">,</span>
                             <span class="s1">&#39;collname&#39;</span><span class="p">:</span> <span class="n">testcol</span><span class="p">,</span>
                             <span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="s1">&#39;training0&#39;</span><span class="p">}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span>
                             <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;more_features&#39;</span><span class="p">]}</span>

    <span class="n">targdict1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                 <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_0/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">get_extraction_target</span><span class="p">,</span>
                 <span class="s1">&#39;to_extract&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_1/validation/valid1/hidden1/output:0&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;more_features&#39;</span><span class="p">:</span> <span class="s1">&#39;model_1/validation/valid1/hidden2/output:0&#39;</span><span class="p">}}</span>

    <span class="n">targdict1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>
    <span class="n">targdict2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">)</span>

    <span class="n">validation_params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                     <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict1</span><span class="p">,</span>
                                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                     <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>

    <span class="n">validation_params2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;valid1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">MNIST</span><span class="p">,</span>
                                                     <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                                     <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;n_threads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
                                     <span class="s1">&#39;queue_params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;fifo&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                                     <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targdict2</span><span class="p">,</span>
                                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                     <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">reduce_mean_dict</span><span class="p">}}</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">validation_params1</span><span class="p">,</span> <span class="n">validation_params2</span><span class="p">]</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">valid_exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation0_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">valid_exp_id</span><span class="p">})</span>

    <span class="c1"># actually run the feature extraction</span>
    <span class="n">base</span><span class="o">.</span><span class="n">test_from_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># check that things are as expected.</span>
    <span class="n">coll</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">testdbname</span><span class="p">][</span><span class="n">testcol</span> <span class="o">+</span> <span class="s1">&#39;.files&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
        <span class="n">exp_id</span> <span class="o">=</span> <span class="s1">&#39;validation1_model_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">11</span>

        <span class="c1"># ... load the containing the final &quot;aggregate&quot; result after all features have been extracted</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
        <span class="k">assert</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># ... check that the record is well-formed</span>
        <span class="n">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ... check that the correct &quot;intermediate results&quot; (the actual features extracted) records exist</span>
        <span class="c1"># and are correctly referenced.</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;validation_results.valid1.intermediate_steps&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ids</span>

        <span class="c1"># ... actually load feature batch 3</span>
        <span class="n">idval</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;item_for&#39;</span><span class="p">:</span> <span class="n">idval</span><span class="p">})[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">testcol</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_last_version</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">saved_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">first_results</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s1">&#39;features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span> <span class="ow">and</span> <span class="s1">&#39;more_features&#39;</span> <span class="ow">in</span> <span class="n">first_results</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
        <span class="n">more_features</span> <span class="o">=</span> <span class="n">saved_data</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="s1">&#39;valid1&#39;</span><span class="p">][</span><span class="s1">&#39;more_features&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">more_features</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span></div>


<div class="viewcode-block" id="asserts_for_record"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.asserts_for_record">[docs]</a><span class="k">def</span> <span class="nf">asserts_for_record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saved_filters&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;_saver_write_version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;_saver_num_data_files&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">float</span>

    <span class="n">should_contain</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">,</span> <span class="s1">&#39;load_params&#39;</span><span class="p">,</span> <span class="s1">&#39;model_params&#39;</span><span class="p">,</span> <span class="s1">&#39;validation_params&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">should_contain</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">vk</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;validation_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">vk1</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">vk</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">vk1</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">][</span><span class="s1">&#39;modname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tfutils.model&#39;</span>
    <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">][</span><span class="s1">&#39;objname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mnist_tfutils&#39;</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;hidden1&#39;</span><span class="p">,</span> <span class="s1">&#39;hidden2&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;softmax_linear&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">_k</span> <span class="o">=</span> <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">should_contain</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;agg_func&#39;</span><span class="p">,</span> <span class="s1">&#39;data_params&#39;</span><span class="p">,</span> <span class="s1">&#39;num_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;online_agg_func&#39;</span><span class="p">,</span> <span class="s1">&#39;queue_params&#39;</span><span class="p">,</span> <span class="s1">&#39;targets&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">should_contain</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;validation_params&#39;</span><span class="p">][</span><span class="n">_k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;queue_params&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

        <span class="n">should_contain</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">,</span> <span class="s1">&#39;optimizer_params&#39;</span><span class="p">,</span> <span class="s1">&#39;train_params&#39;</span><span class="p">,</span> <span class="s1">&#39;learning_rate_params&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">should_contain</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;thres_loss&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;data_params&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">][</span><span class="s1">&#39;modname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tfutils.data&#39;</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;data_params&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">][</span><span class="s1">&#39;objname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MNIST&#39;</span>

        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_params&#39;</span><span class="p">][</span><span class="s1">&#39;agg_func&#39;</span><span class="p">][</span><span class="s1">&#39;modname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tensorflow.python.ops.math_ops&#39;</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_params&#39;</span><span class="p">][</span><span class="s1">&#39;agg_func&#39;</span><span class="p">][</span><span class="s1">&#39;objname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reduce_mean&#39;</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">][</span><span class="s1">&#39;modname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;tensorflow.python.ops.nn_ops&#39;</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">][</span><span class="s1">&#39;objname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sparse_softmax_cross_entropy_with_logits&#39;</span>
        <span class="k">assert</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;loss_params&#39;</span><span class="p">][</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s1">&#39;train_params&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="remove_dbs"><a class="viewcode-back" href="../../../tfutils.tests.html#tfutils.tests.test.remove_dbs">[docs]</a><span class="k">def</span> <span class="nf">remove_dbs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete old test related databases if they exist.&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span><span class="p">,</span>
                          <span class="n">port</span><span class="o">=</span><span class="n">testport</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing:&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">testdbname</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">testdbname</span><span class="p">)]</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, NeuroAILab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>