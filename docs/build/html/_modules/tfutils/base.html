

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tfutils.base &mdash; TFUtils 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="TFUtils 0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> TFUtils
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/overview.html#base-train-from-params"><code class="docutils literal"><span class="pre">base.train_from_params</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/overview.html#base-test-from-params"><code class="docutils literal"><span class="pre">base.test_from_params</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/installation.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/installation.html#id1">Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/getting_started.html#configuring-mongodb">Configuring MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/getting_started.html#specifying-an-experiment">Specifying an Experiment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/getting_started.html#defining-a-model">Defining a Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/getting_started.html#including-validation">Including Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/getting_started.html#train">Train!</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Fundamentals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fundamentals/multigpu.html">Multi-GPU Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fundamentals/multimodel.html">Multi-Model Training</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">tfutils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html">tfutils.base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html#module-tfutils.data">tfutils.data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html#module-tfutils.error">tfutils.error</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html#module-tfutils.model">tfutils.model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html#module-tfutils.optimizer">tfutils.optimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tfutils.html#module-tfutils.utils">tfutils.utils</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">TFUtils</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>tfutils.base</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tfutils.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;base.py&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">er</span>
<span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="kn">import</span> <span class="nn">gridfs</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.core.protobuf</span> <span class="kn">import</span> <span class="n">saver_pb2</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.ops</span> <span class="kn">import</span> <span class="n">variables</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">tfutils.utils</span> <span class="kn">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">tfutils.data</span> <span class="kn">import</span> <span class="n">get_queue</span>
<span class="kn">from</span> <span class="nn">tfutils.optimizer</span> <span class="kn">import</span> <span class="n">ClipOptimizer</span>
<span class="kn">from</span> <span class="nn">tfutils.error</span> <span class="kn">import</span> <span class="n">HiLossError</span><span class="p">,</span> <span class="n">NoGlobalStepError</span><span class="p">,</span> <span class="n">NoChangeError</span>
<span class="kn">from</span> <span class="nn">tfutils.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">sonify</span><span class="p">,</span>
                   <span class="n">frozendict</span><span class="p">,</span>
                   <span class="n">strip_prefix</span><span class="p">,</span>
                   <span class="n">format_devices</span><span class="p">,</span>
                   <span class="n">make_mongo_safe</span><span class="p">,</span>
                   <span class="n">CoordinatedThread</span><span class="p">,</span>
                   <span class="n">aggregate_outputs</span><span class="p">,</span>
                   <span class="n">verify_pb2_v2_files</span><span class="p">,</span>
                   <span class="n">get_saver_pb2_v2_files</span><span class="p">,</span>
                   <span class="n">strip_prefix_from_name</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tfutils&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">TODO:</span>
<span class="sd">    - There should be a dead-simple way to load a human-readable object (as opposed to being in the</span>
<span class="sd">      TF saver binary format) containing filter parameters from a record in the database,</span>
<span class="sd">      without having to load up lots of extraneous objects.</span>
<span class="sd">    - epoch and batch_num should be added to what is saved.   But how to do that with Queues?</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="s1">&#39;TFUTILS_HOME&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">TFUTILS_HOME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TFUTILS_HOME&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">TFUTILS_HOME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">],</span> <span class="s1">&#39;.tfutils&#39;</span><span class="p">)</span>

<span class="n">DEFAULT_MODEL_SEED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DEFAULT_MODEL_TRAIN</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">DEFAULT_MODEL_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="n">DEFAULT_MODEL_SEED</span><span class="p">,</span>
                                   <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">DEFAULT_MODEL_TRAIN</span><span class="p">})</span>
<span class="n">DEFAULT_DONT_RUN</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">DEFAULT_SKIP_CHECK</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">DEFAULT_LOG_DEVICE_PLACEMENT</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">DEFAULT_INTER_OP_PARALLELISM_THREADS</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">DEFAULT_TRAIN_NUM_STEPS</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">DEFAULT_TRAIN_THRES_LOSS</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">DEFAULT_HOST</span> <span class="o">=</span> <span class="s1">&#39;/cpu:0&#39;</span>
<span class="n">DEFAULT_DEVICES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/gpu:0&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:1&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:2&#39;</span><span class="p">,</span> <span class="s1">&#39;/gpu:3&#39;</span><span class="p">]</span>
<span class="n">DEFAULT_LOOP_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">()</span>
<span class="n">DEFAULT_LOAD_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;do_restore&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;from_ckpt&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;to_restore&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;load_param_dict&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">})</span>
<span class="n">DEFAULT_LEARNING_RATE_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">exponential_decay</span><span class="p">})</span>

<span class="n">DEFAULT_LOSS_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                                  <span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">,</span>
                                  <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">})</span>

<span class="n">DEFAULT_OPTIMIZER_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;optimizer_class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">,</span>
                                       <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">})</span>

<span class="n">DEFAULT_SAVE_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span><span class="s1">&#39;save_metrics_freq&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                                  <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                                  <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                                  <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                                  <span class="s1">&#39;save_initial_filters&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                  <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">:</span> <span class="p">(),</span>
                                  <span class="s1">&#39;do_save&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="n">DEFAULT_PARAMS</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">({</span>
    <span class="s1">&#39;dont_run&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s1">&#39;skip_check&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s1">&#39;model_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(),</span>
    <span class="s1">&#39;train_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(),</span>
    <span class="s1">&#39;validation_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(),</span>
    <span class="s1">&#39;log_device_placement&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s1">&#39;inter_op_parallelism_threads&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
    <span class="s1">&#39;save_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">DEFAULT_SAVE_PARAMS</span><span class="p">),</span>
    <span class="s1">&#39;load_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">DEFAULT_LOAD_PARAMS</span><span class="p">),</span>
    <span class="s1">&#39;loss_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">),</span>
    <span class="s1">&#39;optimizer_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">DEFAULT_OPTIMIZER_PARAMS</span><span class="p">),</span>
    <span class="s1">&#39;learning_rate_params&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">DEFAULT_LEARNING_RATE_PARAMS</span><span class="p">),</span>
<span class="p">})</span>


<div class="viewcode-block" id="DBInterface"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface">[docs]</a><span class="k">class</span> <span class="nc">DBInterface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">save_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">load_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">sess</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">global_step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">cache_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">tfsaver_args</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">tfsaver_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :Kwargs:</span>
<span class="sd">            - params (dict)</span>
<span class="sd">                Describing all parameters of experiment</span>
<span class="sd">            - save_params (dict)</span>
<span class="sd">                Describing the parameters need to construct the save database, and</span>
<span class="sd">                control saving.  These include:</span>
<span class="sd">                    - host (str)</span>
<span class="sd">                        Hostname where database connection lives</span>
<span class="sd">                    - port (int)</span>
<span class="sd">                        Port where database connection lives</span>
<span class="sd">                    - dbname (str)</span>
<span class="sd">                        Name of database for storage</span>
<span class="sd">                    - collname (str)</span>
<span class="sd">                        Name of collection for storage</span>
<span class="sd">                    - exp_id (str)</span>
<span class="sd">                        Experiment id descriptor</span>
<span class="sd">                        NOTE: the variables host/port/dbname/coll/exp_id control</span>
<span class="sd">                        the location of the saved data for the run, in order of</span>
<span class="sd">                        increasing specificity.  When choosing these, note that:</span>
<span class="sd">                            1.  If a given host/port/dbname/coll/exp_id already has saved checkpoints,</span>
<span class="sd">                                then any new call to start training with these same location variables</span>
<span class="sd">                                will start to train from the most recent saved checkpoint.  If you mistakenly</span>
<span class="sd">                                try to start training a new model with different variable names, or structure,</span>
<span class="sd">                                from that existing checkpoint, an error will be raised, as the model will be</span>
<span class="sd">                                incompatiable with the saved variables.</span>
<span class="sd">                            2.  When choosing what dbname, coll, and exp_id, to use, keep in mind that mongodb</span>
<span class="sd">                                queries only operate over a single collection.  So if you want to analyze</span>
<span class="sd">                                results from a bunch of experiments together using mongod queries, you should</span>
<span class="sd">                                put them all in the same collection, but with different exp_ids.  If, on the</span>
<span class="sd">                                other hand, you never expect to analyze data from two experiments together,</span>
<span class="sd">                                you can put them in different collections or different databases.  Choosing</span>
<span class="sd">                                between putting two experiments in two collections in the same database</span>
<span class="sd">                                or in two totally different databases will depend on how you want to organize</span>
<span class="sd">                                your results and is really a matter of preference.</span>
<span class="sd">                    - do_save (bool, default: True)</span>
<span class="sd">                        Whether to save to database</span>
<span class="sd">                    - save_initial_filters (bool, default: True)</span>
<span class="sd">                        Whether to save initial model filters at step = 0,</span>
<span class="sd">                    - save_metrics_freq (int, default: 5)</span>
<span class="sd">                        How often to store train results to database</span>
<span class="sd">                    - save_valid_freq (int, default: 3000)</span>
<span class="sd">                        How often to calculate and store validation results</span>
<span class="sd">                                                to database</span>
<span class="sd">                    - save_filters_freq (int, default: 30000)</span>
<span class="sd">                        How often to save filter values to database</span>
<span class="sd">                    - cache_filters_freq (int, default: 3000)</span>
<span class="sd">                        How often to cache filter values locally and save</span>
<span class="sd">                        to ___RECENT database</span>
<span class="sd">                    - cache_dir (str, default: None)</span>
<span class="sd">                        Path where caches will be saved locally. If None, will default to</span>
<span class="sd">                        ~/.tfutils/&lt;host:post&gt;/&lt;dbname&gt;/&lt;collname&gt;/&lt;exp_id&gt;.</span>
<span class="sd">            - load_params (dict)</span>
<span class="sd">                Similar to save_params, if you want loading to happen from a different</span>
<span class="sd">                location than where saving occurs.   Parameters include:</span>
<span class="sd">                    - host (str)</span>
<span class="sd">                        Hostname where database connection lives</span>
<span class="sd">                    - port (int)</span>
<span class="sd">                        Port where database connection lives</span>
<span class="sd">                    - dbname (str)</span>
<span class="sd">                        Name of database for storage</span>
<span class="sd">                    - collname (str)</span>
<span class="sd">                        Name of collection for storage</span>
<span class="sd">                    - exp_id (str)</span>
<span class="sd">                        Experiment id descriptor</span>
<span class="sd">                    - do_restore (bool, default: True)</span>
<span class="sd">                        Whether to restore from saved model</span>
<span class="sd">                    - load_query (dict)</span>
<span class="sd">                        mongodb query describing how to load from loading database</span>
<span class="sd">                    - from_ckpt (string)</span>
<span class="sd">                        Path to load from a TensorFlow checkpoint (instead of from the db)</span>
<span class="sd">                    - to_restore (list of strings or a regex/callable which returns strings)</span>
<span class="sd">                        Specifies which variables should be loaded from the checkpoint.</span>
<span class="sd">                        Any variables not specified here will be reinitialized.</span>
<span class="sd">                    - load_param_dict (dict)</span>
<span class="sd">                        A dictionary whose keys are the names of the variables that are to be loaded</span>
<span class="sd">                        from the checkpoint, and the values are the names of the variables of the model</span>
<span class="sd">                        that you want to restore with the value of the corresponding checkpoint variable.</span>
<span class="sd">            - sess (tesorflow.Session)</span>
<span class="sd">                Object in which to run calculations.  This is required if actual loading/</span>
<span class="sd">                saving is going to be done (as opposed to just e.g. getting elements from</span>
<span class="sd">                the MongoDB).</span>
<span class="sd">            - global_step (tensorflow.Variable)</span>
<span class="sd">                Global step variable, the one that is updated by apply_gradients.  This</span>
<span class="sd">                is required if being using in a training context.</span>
<span class="sd">            - *tfsaver_args, **tsaver_kwargs</span>
<span class="sd">                Additional arguments to be passed onto base Saver class constructor</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skip_check</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_check&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skip_check</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Skipping version check and info...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sonified_params</span> <span class="o">=</span> <span class="n">sonify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_check</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span> <span class="o">=</span> <span class="n">save_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_params</span> <span class="o">=</span> <span class="n">load_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="n">global_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfsaver_args</span> <span class="o">=</span> <span class="n">tfsaver_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfsaver_kwargs</span> <span class="o">=</span> <span class="n">tfsaver_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_list</span> <span class="o">=</span> <span class="n">tfsaver_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;var_list&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">save_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">load_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">load_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">location_variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="s1">&#39;collname&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_id&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">location_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">save_params</span><span class="p">:</span>
                <span class="n">sv</span> <span class="o">=</span> <span class="n">save_params</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sv</span> <span class="o">=</span> <span class="n">load_params</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">load_params</span><span class="p">:</span>
                <span class="n">lv</span> <span class="o">=</span> <span class="n">load_params</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lv</span> <span class="o">=</span> <span class="n">save_params</span><span class="p">[</span><span class="n">_k</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_k</span><span class="p">,</span> <span class="n">sv</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;load_&#39;</span> <span class="o">+</span> <span class="n">_k</span><span class="p">,</span> <span class="n">lv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;load_&#39;</span> <span class="o">+</span> <span class="n">_k</span><span class="p">)</span> <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">location_variables</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;query&#39;</span> <span class="ow">in</span> <span class="n">load_params</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">load_params</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s1">&#39;exp_id&#39;</span> <span class="ow">in</span> <span class="n">load_params</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">load_params</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;do_save&#39;</span><span class="p">,</span> <span class="s1">&#39;save_metrics_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;save_valid_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;cache_filters_freq&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;save_filters_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;save_initial_filters&#39;</span><span class="p">,</span> <span class="s1">&#39;save_to_gfs&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_k</span><span class="p">,</span> <span class="n">save_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_k</span><span class="p">,</span> <span class="n">DEFAULT_SAVE_PARAMS</span><span class="p">[</span><span class="n">_k</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;do_restore&#39;</span><span class="p">,</span> <span class="s1">&#39;from_ckpt&#39;</span><span class="p">,</span> <span class="s1">&#39;to_restore&#39;</span><span class="p">,</span> <span class="s1">&#39;load_param_dict&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_k</span><span class="p">,</span> <span class="n">load_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_k</span><span class="p">,</span> <span class="n">DEFAULT_LOAD_PARAMS</span><span class="p">[</span><span class="n">_k</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rec_to_save</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_thread</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outrecs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">server_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collfs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">collname</span><span class="p">)</span>

        <span class="n">recent_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">,</span> <span class="s1">&#39;__RECENT&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collfs_recent</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">recent_name</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">load_query</span> <span class="o">=</span> <span class="n">load_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">load_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">load_query</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">save_params</span> <span class="o">==</span> <span class="p">{}):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Loading pointlessly&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c1"># print(&#39;Set sameloc to False!&#39;)</span>

        <span class="k">if</span> <span class="s1">&#39;exp_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">load_query</span><span class="p">:</span>
            <span class="n">load_query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_exp_id</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_query</span> <span class="o">=</span> <span class="n">load_query</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_host</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_port</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_conn</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_host</span><span class="p">,</span>
                                                 <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_port</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_conn</span><span class="o">.</span><span class="n">server_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_collfs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_conn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_dbname</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">load_collname</span><span class="p">)</span>
        <span class="n">load_recent_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">load_dbname</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">load_collname</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">load_exp_id</span><span class="p">,</span>
                                     <span class="s1">&#39;__RECENT&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_collfs_recent</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_conn</span><span class="p">[</span><span class="n">load_recent_name</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;cache_dir&#39;</span> <span class="ow">in</span> <span class="n">save_params</span><span class="p">:</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">save_params</span><span class="p">[</span><span class="s1">&#39;cache_dir&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TFUTILS_HOME</span><span class="p">,</span>
                                          <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">collname</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>

<div class="viewcode-block" id="DBInterface.load_rec"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.load_rec">[docs]</a>    <span class="k">def</span> <span class="nf">load_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># first try and see if anything with the save data exists, since obviously</span>
        <span class="c1"># we dont&#39; want to keep loading from the original load location if some work has</span>
        <span class="c1"># already been done</span>
        <span class="n">load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_db</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">},</span>
                                 <span class="n">cache_filters</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># if not, try loading from the loading location</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sameloc</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_query</span><span class="p">,</span>
                                     <span class="n">cache_filters</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                     <span class="n">collfs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_collfs</span><span class="p">,</span>
                                     <span class="n">collfs_recent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_collfs_recent</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">load</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;You specified load parameters but no &#39;</span>
                                <span class="s1">&#39;record was found with the given spec.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span> <span class="o">=</span> <span class="n">load</span></div>

<div class="viewcode-block" id="DBInterface.initialize"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_scratch</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch record then uses tf&#39;s saver.restore.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restore</span><span class="p">:</span>

            <span class="c1"># First, determine which checkpoint to use.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_ckpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># Use a cached checkpoint file.</span>
                <span class="n">ckpt_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_ckpt</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restoring variables from checkpoint </span><span class="si">%s</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="n">ckpt_filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, use a database checkpoint.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_rec</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">rec</span><span class="p">,</span> <span class="n">ckpt_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restoring variables from record </span><span class="si">%s</span><span class="s1"> (step </span><span class="si">%d</span><span class="s1">)...&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]),</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No db checkpoint to load.</span>
                    <span class="n">ckpt_filename</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">ckpt_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">all_vars</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">()</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">local_variables</span><span class="p">()</span>  <span class="c1"># get list of all variables</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span> <span class="o">=</span> <span class="n">strip_prefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">all_vars</span><span class="p">)</span>

                <span class="c1"># Next, determine which vars should be restored from the specified checkpoint.</span>
                <span class="n">restore_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restore_vars</span><span class="p">(</span><span class="n">ckpt_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">)</span>
                <span class="n">restore_stripped</span> <span class="o">=</span> <span class="n">strip_prefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">restore_vars</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">restore_names</span> <span class="o">=</span>  <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">restore_stripped</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="c1"># Actually load the vars.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restored Vars:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">restore_names</span><span class="p">))</span>
                <span class="n">tf_saver_restore</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">(</span><span class="n">restore_vars</span><span class="p">)</span>
                <span class="n">tf_saver_restore</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">ckpt_filename</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... done restoring.&#39;</span><span class="p">)</span>

                <span class="c1"># Reinitialize all other, unrestored vars.</span>
                <span class="n">unrestored_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restore_names</span><span class="p">]</span>
                <span class="n">unrestored_var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restore_names</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unrestored Vars:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unrestored_var_names</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">variables_initializer</span><span class="p">(</span><span class="n">unrestored_vars</span><span class="p">))</span>  <span class="c1"># initialize variables not restored</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">report_uninitialized_variables</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">report_uninitialized_variables</span><span class="p">()))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restore</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_ckpt</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">init_op_global</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_global</span><span class="p">)</span>
            <span class="n">init_op_local</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">local_variables_initializer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_local</span><span class="p">)</span></div>

<div class="viewcode-block" id="DBInterface.get_restore_vars"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.get_restore_vars">[docs]</a>    <span class="k">def</span> <span class="nf">get_restore_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_file</span><span class="p">,</span> <span class="n">all_vars</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the `var_list` init argument to tf.Saver from save_file.</span>

<span class="sd">        Extracts the subset of variables from tf.global_variables that match the</span>
<span class="sd">        name and shape of variables saved in the checkpoint file, and returns these</span>
<span class="sd">        as a list of variables to restore.</span>

<span class="sd">        To support multi-model training, a model prefix is prepended to all</span>
<span class="sd">        tf global_variable names, although this prefix is stripped from</span>
<span class="sd">        all variables before they are saved to a checkpoint. Thus,</span>


<span class="sd">        Args:</span>
<span class="sd">            save_file: path of tf.train.Saver checkpoint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: checkpoint variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">NewCheckpointReader</span><span class="p">(</span><span class="n">save_file</span><span class="p">)</span>
        <span class="n">var_shapes</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_variable_to_shape_map</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved Vars:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">var_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">var_shapes</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Strip the prefix off saved var names.</span>
            <span class="n">strip_prefix_from_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">name</span><span class="p">):</span> <span class="n">shape</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">var_shapes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Map old vars from checkpoint to new vars via load_param_dict.</span>
        <span class="n">mapped_var_shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remap_var_list</span><span class="p">(</span><span class="n">var_shapes</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved shapes:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mapped_var_shapes</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">all_vars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">all_vars</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">()</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">local_variables</span><span class="p">()</span>  <span class="c1"># get list of all variables</span>
            <span class="n">all_vars</span> <span class="o">=</span> <span class="n">strip_prefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">all_vars</span><span class="p">)</span>

        <span class="c1"># Specify which vars are to be restored vs. reinitialized.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_param_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">restore_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mapped_var_shapes</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># associate checkpoint names with actual variables</span>
            <span class="n">load_var_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ckpt_var_name</span><span class="p">,</span> <span class="n">curr_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">curr_name</span><span class="p">,</span> <span class="n">curr_var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">curr_name</span> <span class="o">==</span> <span class="n">curr_var_name</span><span class="p">:</span>
                        <span class="n">load_var_dict</span><span class="p">[</span><span class="n">ckpt_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_var</span>
                        <span class="k">break</span>

            <span class="n">restore_vars</span> <span class="o">=</span> <span class="n">load_var_dict</span>

        <span class="n">restore_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_var_list</span><span class="p">(</span><span class="n">restore_vars</span><span class="p">)</span>

        <span class="c1"># Ensure the vars to restored have the correct shape.</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">restore_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">var_shape</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">var_shape</span> <span class="o">==</span> <span class="n">mapped_var_shapes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="n">var_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var_list</span></div>

<div class="viewcode-block" id="DBInterface.remap_var_list"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.remap_var_list">[docs]</a>    <span class="k">def</span> <span class="nf">remap_var_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map old vars in checkpoint to new vars in current session.</span>

<span class="sd">        Args:</span>
<span class="sd">            var_list (dict): var names mapped to variables (or some related</span>
<span class="sd">            quantity, such as variable shapes).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: New var names mapped to the corresponding restored var.</span>

<span class="sd">        Examples:</span>
<span class="sd">        &gt;&gt;&gt;var_list</span>
<span class="sd">        {&#39;Weights&#39;: &lt;tf.Variable&gt;}</span>
<span class="sd">        &gt;&gt;&gt;self.load_param_dict</span>
<span class="sd">        {&#39;Weights&#39;: &#39;Filters&#39;}</span>
<span class="sd">        &gt;&gt;&gt;self.remap_var_list(var_list)</span>
<span class="sd">        {&#39;Filters&#39;: &lt;tf.Variable&gt;}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_param_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No variable mapping specified.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">var_list</span>
        <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">old_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">var_list</span><span class="p">[</span><span class="n">old_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">var_list</span></div>

<div class="viewcode-block" id="DBInterface.filter_var_list"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.filter_var_list">[docs]</a>    <span class="k">def</span> <span class="nf">filter_var_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter checkpoint vars for those to be restored.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint_vars (list): Vars that can be restored from checkpoint.</span>
<span class="sd">            to_restore (list[str] or regex, optional): Selects vars to restore.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Variables to be restored from checkpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var_list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">_pattern_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="p">}</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;to_restore ({}) unsupported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_restore</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tf_saver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_tf_saver&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tf_saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tfsaver_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">tfsaver_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tf_saver</span>

<div class="viewcode-block" id="DBInterface.load_from_db"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.load_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">query</span><span class="p">,</span>
                     <span class="n">cache_filters</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">collfs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">collfs_recent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load checkpoint from the database.</span>

<span class="sd">        Checks the recent and regular checkpoint fs to find the latest one</span>
<span class="sd">        matching the query. Returns the GridOut obj corresponding to the</span>
<span class="sd">        record.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: dict expressing MongoDB query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">collfs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">collfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collfs</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="n">collfs</span><span class="o">.</span><span class="n">_GridFS__files</span>
        <span class="k">if</span> <span class="n">collfs_recent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">collfs_recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collfs_recent</span>
        <span class="n">coll_recent</span> <span class="o">=</span> <span class="n">collfs_recent</span><span class="o">.</span><span class="n">_GridFS__files</span>

        <span class="n">query</span><span class="p">[</span><span class="s1">&#39;saved_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">collfs</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># get latest that matches query</span>
            <span class="n">ckpt_record</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;uploadDate&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loading_from</span> <span class="o">=</span> <span class="n">coll</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ckpt_record</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">count_recent</span> <span class="o">=</span> <span class="n">collfs_recent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">er</span><span class="o">.</span><span class="n">OperationFailure</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Is your dbname too long? Mongo requires that dbnames be no longer than 64 characters.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count_recent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># get latest that matches query</span>
            <span class="n">ckpt_record_recent</span> <span class="o">=</span> <span class="n">coll_recent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;uploadDate&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># use the record with latest timestamp</span>
            <span class="k">if</span> <span class="n">ckpt_record</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ckpt_record_recent</span><span class="p">[</span><span class="s1">&#39;uploadDate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ckpt_record</span><span class="p">[</span><span class="s1">&#39;uploadDate&#39;</span><span class="p">]:</span>
                <span class="n">loading_from</span> <span class="o">=</span> <span class="n">coll_recent</span>
                <span class="n">ckpt_record</span> <span class="o">=</span> <span class="n">ckpt_record_recent</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">+</span> <span class="n">count_recent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no matches for query</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No matching checkpoint for query &quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span>
            <span class="k">return</span>

        <span class="n">database</span> <span class="o">=</span> <span class="n">loading_from</span><span class="o">.</span><span class="n">_Collection__database</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">loading_from</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_filters</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ckpt_record</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
            <span class="n">cache_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># check if there is no local copy</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No cache file at </span><span class="si">%s</span><span class="s1">, loading from DB&#39;</span> <span class="o">%</span> <span class="n">cache_filename</span><span class="p">)</span>
                <span class="c1"># create new file to write from gridfs</span>
                <span class="n">load_dest</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
                <span class="n">load_dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">load_dest</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="s1">&#39;rwb+&#39;</span><span class="p">)</span>
                <span class="n">fsbucket</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFSBucket</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">bucket_name</span><span class="o">=</span><span class="n">loading_from</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fsbucket</span><span class="o">.</span><span class="n">download_to_stream</span><span class="p">(</span><span class="n">ckpt_record</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="n">load_dest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ckpt_record</span><span class="p">[</span><span class="s1">&#39;_saver_write_version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">saver_pb2</span><span class="o">.</span><span class="n">SaverDef</span><span class="o">.</span><span class="n">V2</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">cache_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar&#39;</span><span class="p">)</span>
                    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">)</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">cache_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">verify_pb2_v2_files</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="n">ckpt_record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ckpt_record</span><span class="p">[</span><span class="s1">&#39;_saver_write_version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">saver_pb2</span><span class="o">.</span><span class="n">SaverDef</span><span class="o">.</span><span class="n">V2</span><span class="p">:</span>
                    <span class="n">cache_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">verify_pb2_v2_files</span><span class="p">(</span><span class="n">cache_filename</span><span class="p">,</span> <span class="n">ckpt_record</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cache file found at </span><span class="si">%s</span><span class="s1">, using that to load&#39;</span> <span class="o">%</span>
                         <span class="n">cache_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cache_filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">ckpt_record</span><span class="p">,</span> <span class="n">cache_filename</span></div>

<div class="viewcode-block" id="DBInterface.save"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_res</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">valid_res</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validation_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually save record into DB and makes local filter caches.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">train_res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">train_res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">valid_res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valid_res</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">validation_only</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">step</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NoGlobalStepError</span><span class="p">(</span><span class="s1">&#39;If step is none, you must pass global_step&#39;</span>
                                        <span class="s1">&#39; tensorflow operation to the saver.&#39;</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">)</span>

        <span class="n">train_res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span>
        <span class="n">valid_res</span> <span class="o">=</span> <span class="p">{</span><span class="n">_k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">_v</span><span class="p">)</span> <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time_step</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_to_save</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">,</span>
                   <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sonified_params</span><span class="p">,</span>
                   <span class="s1">&#39;saved_filters&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                   <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec_to_save</span> <span class="o">=</span> <span class="n">rec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_to_save</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># TODO: also include error rate of the train set to monitor overfitting</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Step {} ({:.0f} ms) -- &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">duration</span><span class="p">)</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{}: {:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">train_res</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="s1">&#39;__grads__&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_gfs</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;__grads__&#39;</span> <span class="ow">in</span> <span class="n">train_res</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">train_res</span><span class="p">[</span><span class="s1">&#39;__grads__&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;optimizer&#39;</span> <span class="ow">in</span> <span class="n">train_res</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">train_res</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_res</span><span class="p">)</span>

        <span class="c1"># print validation set performance</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_res</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Validation -- &#39;</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="p">{</span><span class="n">_k</span><span class="p">:</span> <span class="n">_v</span> <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">_k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_gfs</span><span class="p">})</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">validation_only</span><span class="p">:</span>
            <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;validates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
            <span class="n">save_filters_permanent</span> <span class="o">=</span> <span class="n">save_filters_tmp</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">need_to_save</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_filters_permanent</span> <span class="o">=</span> <span class="p">((</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_filters_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
                                      <span class="p">(</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_initial_filters</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">)))</span>
            <span class="n">save_filters_tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_filters_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="p">(</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_initial_filters</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">)))</span>
            <span class="n">save_metrics_now</span> <span class="o">=</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_metrics_freq</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">save_valid_now</span> <span class="o">=</span> <span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_valid_freq</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">need_to_save</span> <span class="o">=</span> <span class="n">save_filters_permanent</span> <span class="ow">or</span> <span class="n">save_filters_tmp</span> <span class="ow">or</span> <span class="n">save_metrics_now</span> <span class="ow">or</span> <span class="n">save_valid_now</span>

        <span class="n">need_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_save</span> <span class="ow">and</span> <span class="n">need_to_save</span>

        <span class="k">if</span> <span class="n">need_to_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec_to_save</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_with_host</span><span class="p">()</span>
            <span class="n">save_to_gfs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_to_gfs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">train_res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;train_results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_to_gfs</span><span class="p">:</span>
                        <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">train_res</span><span class="p">:</span>
                        <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="n">_k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="n">_k</span><span class="p">]</span> <span class="o">==</span> <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;train_results&#39;</span><span class="p">][</span><span class="n">_k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">valid_res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;validation_results&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_to_gfs</span><span class="p">:</span>
                        <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">_vk</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_vk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">]:</span>
                            <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="n">_vk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">valid_res</span><span class="p">[</span><span class="n">_vk</span><span class="p">]:</span>
                            <span class="n">save_to_gfs</span><span class="p">[</span><span class="s1">&#39;validation_results&#39;</span><span class="p">][</span><span class="n">_vk</span><span class="p">][</span><span class="n">_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_res</span><span class="p">[</span><span class="n">_vk</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span>

            <span class="n">save_rec</span> <span class="o">=</span> <span class="n">sonify</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_check</span><span class="p">)</span>
            <span class="n">make_mongo_safe</span><span class="p">(</span><span class="n">save_rec</span><span class="p">)</span>

            <span class="n">coord</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Coordinator</span><span class="p">()</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">CoordinatedThread</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
                                       <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_thread</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">save_filters_permanent</span><span class="p">,</span>
                                             <span class="n">save_filters_tmp</span><span class="p">,</span>
                                             <span class="n">save_rec</span><span class="p">,</span>
                                             <span class="n">step</span><span class="p">,</span>
                                             <span class="n">save_to_gfs</span><span class="p">))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_thread</span> <span class="o">=</span> <span class="n">thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_coord</span> <span class="o">=</span> <span class="n">coord</span></div>

<div class="viewcode-block" id="DBInterface.sync_with_host"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.DBInterface.sync_with_host">[docs]</a>    <span class="k">def</span> <span class="nf">sync_with_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_coord</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_thread</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;A checkpoint thead raised an exception &#39;</span>
                            <span class="s1">&#39;while saving a checkpoint.&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_thread</span> <span class="o">=</span> <span class="bp">None</span></div>

    <span class="k">def</span> <span class="nf">_save_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_filters_permanent</span><span class="p">,</span> <span class="n">save_filters_tmp</span><span class="p">,</span> <span class="n">save_rec</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">save_to_gfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">save_filters_permanent</span> <span class="ow">or</span> <span class="n">save_filters_tmp</span><span class="p">:</span>
            <span class="n">save_rec</span><span class="p">[</span><span class="s1">&#39;saved_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving model with path prefix </span><span class="si">%s</span><span class="s1"> ... &#39;</span> <span class="o">%</span> <span class="n">save_path</span><span class="p">)</span>
            <span class="n">saved_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span>
                                            <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
                                            <span class="n">global_step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
                                            <span class="n">write_meta_graph</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... done saving with path prefix </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">saved_path</span><span class="p">)</span>
            <span class="n">putfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collfs</span> <span class="k">if</span> <span class="n">save_filters_permanent</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">collfs_recent</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Putting filters into </span><span class="si">%s</span><span class="s1"> database&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">putfs</span><span class="p">))</span>
            <span class="n">save_rec</span><span class="p">[</span><span class="s1">&#39;_saver_write_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_saver</span><span class="o">.</span><span class="n">_write_version</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_saver</span><span class="o">.</span><span class="n">_write_version</span> <span class="o">==</span> <span class="n">saver_pb2</span><span class="o">.</span><span class="n">SaverDef</span><span class="o">.</span><span class="n">V2</span><span class="p">:</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">get_saver_pb2_v2_files</span><span class="p">(</span><span class="n">saved_path</span><span class="p">)</span>
                <span class="n">save_rec</span><span class="p">[</span><span class="s1">&#39;_saver_num_data_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;num_data_files&#39;</span><span class="p">]</span>
                <span class="n">tarfilepath</span> <span class="o">=</span> <span class="n">saved_path</span> <span class="o">+</span> <span class="s1">&#39;.tar&#39;</span>
                <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tarfilepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]:</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_f</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_f</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tarfilepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_fp</span><span class="p">:</span>
                    <span class="n">outrec</span> <span class="o">=</span> <span class="n">putfs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_fp</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">tarfilepath</span><span class="p">,</span> <span class="o">**</span><span class="n">save_rec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">saved_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_fp</span><span class="p">:</span>
                    <span class="n">outrec</span> <span class="o">=</span> <span class="n">putfs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_fp</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">saved_path</span><span class="p">,</span> <span class="o">**</span><span class="n">save_rec</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;... done putting filters into database.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_filters_permanent</span><span class="p">:</span>
            <span class="n">save_rec</span><span class="p">[</span><span class="s1">&#39;saved_filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserting record into database.&#39;</span><span class="p">)</span>
            <span class="n">outrec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collfs</span><span class="o">.</span><span class="n">_GridFS__files</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">save_rec</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outrec</span><span class="p">,</span> <span class="n">ObjectId</span><span class="p">):</span>
            <span class="n">outrec</span> <span class="o">=</span> <span class="n">outrec</span><span class="o">.</span><span class="n">inserted_id</span>

        <span class="k">if</span> <span class="n">save_to_gfs</span><span class="p">:</span>
            <span class="n">idval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outrec</span><span class="p">)</span>
            <span class="n">save_to_gfs_path</span> <span class="o">=</span> <span class="n">idval</span> <span class="o">+</span> <span class="s2">&quot;_fileitems&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collfs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">save_to_gfs</span><span class="p">),</span>
                            <span class="n">filename</span><span class="o">=</span><span class="n">save_to_gfs_path</span><span class="p">,</span> <span class="n">item_for</span><span class="o">=</span><span class="n">outrec</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># flush the stdout buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outrecs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outrec</span><span class="p">)</span></div>


<div class="viewcode-block" id="predict"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.predict">[docs]</a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>

    <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">preds</span></div>


<div class="viewcode-block" id="run_targets"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.run_targets">[docs]</a><span class="k">def</span> <span class="nf">run_targets</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                <span class="n">dbinterface</span><span class="p">,</span>
                <span class="n">target_name</span><span class="p">,</span>
                <span class="n">target</span><span class="p">,</span>
                <span class="n">valid_loop</span><span class="p">,</span>
                <span class="n">num_steps</span><span class="p">,</span>
                <span class="n">online_agg_func</span><span class="p">,</span>
                <span class="n">agg_func</span><span class="p">,</span>
                <span class="n">save_intermediate_freq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">validation_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TODO:  this code resembles train() function, possible want to unify.&quot;&quot;&quot;</span>
    <span class="n">agg_res</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">save_intermediate_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbinterface</span><span class="o">.</span><span class="n">outrecs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_step</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">target_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">valid_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">valid_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;keys&#39;</span><span class="p">),</span> <span class="s1">&#39;result must be a dictionary&#39;</span>
        <span class="k">if</span> <span class="n">save_intermediate_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">_step</span> <span class="o">%</span> <span class="n">save_intermediate_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dbinterface</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">valid_res</span><span class="o">=</span><span class="p">{</span><span class="n">target_name</span><span class="p">:</span> <span class="n">res</span><span class="p">},</span>
                             <span class="n">step</span><span class="o">=</span><span class="n">_step</span><span class="p">,</span>
                             <span class="n">validation_only</span><span class="o">=</span><span class="n">validation_only</span><span class="p">)</span>
        <span class="n">agg_res</span> <span class="o">=</span> <span class="n">online_agg_func</span><span class="p">(</span><span class="n">agg_res</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_step</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">agg_func</span><span class="p">(</span><span class="n">agg_res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_intermediate_freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dbinterface</span><span class="o">.</span><span class="n">sync_with_host</span><span class="p">()</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbinterface</span><span class="o">.</span><span class="n">outrecs</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;intermediate_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbinterface</span><span class="o">.</span><span class="n">outrecs</span><span class="p">[</span><span class="n">n0</span><span class="p">:</span> <span class="n">n1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="run_targets_dict"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.run_targets_dict">[docs]</a><span class="k">def</span> <span class="nf">run_targets_dict</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                     <span class="n">targets</span><span class="p">,</span>
                     <span class="n">save_intermediate_freq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">dbinterface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">validation_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for actually computing validation results.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">target_name</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">num_steps</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_name</span><span class="p">][</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_name</span><span class="p">][</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span>
        <span class="n">agg_func</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_name</span><span class="p">][</span><span class="s1">&#39;agg_func&#39;</span><span class="p">]</span>
        <span class="n">online_agg_func</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_name</span><span class="p">][</span><span class="s1">&#39;online_agg_func&#39;</span><span class="p">]</span>
        <span class="n">valid_loop</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">target_name</span><span class="p">][</span><span class="s1">&#39;valid_loop&#39;</span><span class="p">]</span>
        <span class="n">results</span><span class="p">[</span><span class="n">target_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_targets</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                                           <span class="n">dbinterface</span><span class="p">,</span>
                                           <span class="n">target_name</span><span class="p">,</span>
                                           <span class="n">target</span><span class="p">,</span>
                                           <span class="n">valid_loop</span><span class="p">,</span>
                                           <span class="n">num_steps</span><span class="p">,</span>
                                           <span class="n">online_agg_func</span><span class="p">,</span>
                                           <span class="n">agg_func</span><span class="p">,</span>
                                           <span class="n">save_intermediate_freq</span><span class="p">,</span>
                                           <span class="n">validation_only</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dbinterface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dbinterface</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">valid_res</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">validation_only</span><span class="o">=</span><span class="n">validation_only</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="start_queues"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.start_queues">[docs]</a><span class="k">def</span> <span class="nf">start_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for starting queues before running processes.&quot;&quot;&quot;</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Coordinator</span><span class="p">()</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">start_queue_runners</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span> <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord</span><span class="p">,</span> <span class="n">threads</span></div>


<div class="viewcode-block" id="stop_queues"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.stop_queues">[docs]</a><span class="k">def</span> <span class="nf">stop_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for stopping queues cleanly.&quot;&quot;&quot;</span>
    <span class="n">coord</span><span class="o">.</span><span class="n">request_stop</span><span class="p">()</span>
    <span class="n">coord</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">queues</span><span class="p">:</span>
        <span class="n">close_op</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">cancel_pending_enqueues</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">close_op</span><span class="p">)</span></div>


<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
         <span class="n">queues</span><span class="p">,</span>
         <span class="n">dbinterface</span><span class="p">,</span>
         <span class="n">validation_targets</span><span class="p">,</span>
         <span class="n">save_intermediate_freq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actually runs the testing evaluation loop.</span>

<span class="sd">    Args:</span>
<span class="sd">        sess (tensorflow.Session): Object in which to run calculations</span>
<span class="sd">        queues (list of CustomQueue): Objects containing asynchronously queued data iterators</span>
<span class="sd">        dbinterface (DBInterface object): Saver through which to save results</span>
<span class="sd">        validation_targets (dict of tensorflow objects): Objects on which validation will be computed.</span>
<span class="sd">        save_intermediate_freq (None or int): How frequently to save intermediate results captured during test</span>
<span class="sd">            None means no intermediate saving will be saved</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Validation summary.</span>
<span class="sd">        dict: Results.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Collect args in a dict of lists</span>
    <span class="n">test_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;queues&#39;</span><span class="p">:</span> <span class="n">queues</span><span class="p">,</span>
        <span class="s1">&#39;dbinterface&#39;</span><span class="p">:</span> <span class="n">dbinterface</span><span class="p">,</span>
        <span class="s1">&#39;validation_targets&#39;</span><span class="p">:</span> <span class="n">validation_targets</span><span class="p">,</span>
        <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="n">save_intermediate_freq</span><span class="p">}</span>

    <span class="n">_ttargs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_args</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">queues</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">ttarg</span> <span class="ow">in</span> <span class="n">_ttargs</span><span class="p">:</span>

        <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>
        <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">validation_summary</span> <span class="o">=</span> <span class="n">run_targets_dict</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                                              <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;validation_targets&#39;</span><span class="p">],</span>
                                              <span class="n">save_intermediate_freq</span><span class="o">=</span><span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">],</span>
                                              <span class="n">dbinterface</span><span class="o">=</span><span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">],</span>
                                              <span class="n">validation_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ttarg</span> <span class="ow">in</span> <span class="n">_ttargs</span><span class="p">:</span>
        <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sync_with_host</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">outrecs</span><span class="p">)</span>
        <span class="n">stop_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;queues&#39;</span><span class="p">],</span> <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">validation_summary</span><span class="p">,</span> <span class="n">res</span></div>


<div class="viewcode-block" id="test_from_params"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.test_from_params">[docs]</a><span class="k">def</span> <span class="nf">test_from_params</span><span class="p">(</span><span class="n">load_params</span><span class="p">,</span>
                     <span class="n">model_params</span><span class="p">,</span>
                     <span class="n">validation_params</span><span class="p">,</span>
                     <span class="n">log_device_placement</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">save_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">dont_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">skip_check</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                     <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main testing interface function.</span>

<span class="sd">    Same as train_from_parameters; but just performs testing without training.</span>

<span class="sd">    For documentation, see argument descriptions in train_from_params.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">test_args</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                     <span class="n">model_params</span><span class="p">,</span>
                                     <span class="n">dont_run</span><span class="o">=</span><span class="n">dont_run</span><span class="p">,</span>
                                     <span class="n">skip_check</span><span class="o">=</span><span class="n">skip_check</span><span class="p">,</span>
                                     <span class="n">save_params</span><span class="o">=</span><span class="n">save_params</span><span class="p">,</span>
                                     <span class="n">load_params</span><span class="o">=</span><span class="n">load_params</span><span class="p">,</span>
                                     <span class="n">validation_params</span><span class="o">=</span><span class="n">validation_params</span><span class="p">,</span>
                                     <span class="n">log_device_placement</span><span class="o">=</span><span class="n">log_device_placement</span><span class="p">,</span>
                                     <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="n">inter_op_parallelism_threads</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEFAULT_HOST</span><span class="p">):</span>

        <span class="c1"># create session</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">(</span><span class="n">allow_soft_placement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">log_device_placement</span><span class="o">=</span><span class="n">log_device_placement</span><span class="p">,</span>
                                                <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="n">inter_op_parallelism_threads</span><span class="p">))</span>

        <span class="n">init_op_global</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_global</span><span class="p">)</span>
        <span class="n">init_op_local</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">local_variables_initializer</span><span class="p">()</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_local</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initialized from scratch first&#39;</span><span class="p">)</span>

        <span class="c1"># For convenience, use list of dicts instead of dict of lists</span>
        <span class="n">_params</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]))]</span>
        <span class="n">_ttargs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_args</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]))]</span>

        <span class="c1"># Build a graph for each distinct model.</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">ttarg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span> <span class="n">_ttargs</span><span class="p">):</span>

            <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DBInterface</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">load_params</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">])</span>
            <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load_rec</span><span class="p">()</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load_data</span>
            <span class="k">assert</span> <span class="n">ld</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;No load data found for query, aborting&quot;</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># TODO: have option to reconstitute model_params entirely from</span>
            <span class="c1"># saved object (&quot;revivification&quot;)</span>
            <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
            <span class="n">cfg_final</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">]</span>
            <span class="n">train_queue_params</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;queue_params&#39;</span><span class="p">]</span>

            <span class="p">(</span><span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;validation_targets&#39;</span><span class="p">],</span>
             <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;queues&#39;</span><span class="p">])</span> <span class="o">=</span> <span class="n">get_valid_targets_dict</span><span class="p">(</span><span class="n">loss_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                                       <span class="n">cfg_final</span><span class="o">=</span><span class="n">cfg_final</span><span class="p">,</span>
                                                       <span class="n">queue_params</span><span class="o">=</span><span class="n">train_queue_params</span><span class="p">,</span>
                                                       <span class="o">**</span><span class="n">param</span><span class="p">)</span>

            <span class="c1"># tf.get_variable_scope().reuse_variables()</span>

            <span class="n">param</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">][</span><span class="s1">&#39;do_restore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg_final</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">all_vars</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">_all_saveable_objects</span><span class="p">()</span>
            <span class="n">var_list</span> <span class="o">=</span> <span class="n">strip_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">)</span>

            <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DBInterface</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span>
                                               <span class="n">params</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
                                               <span class="n">var_list</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
                                               <span class="n">load_params</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">],</span>
                                               <span class="n">save_params</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">])</span>
            <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">no_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ttarg</span><span class="p">[</span><span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">)</span>

        <span class="c1"># Convert back to a dictionary of lists</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">_params</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">test_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">ttarg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">ttarg</span> <span class="ow">in</span> <span class="n">_ttargs</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_ttargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">dont_run</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">test_args</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">test_args</span><span class="p">)</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="train_loop"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.train_loop">[docs]</a><span class="k">def</span> <span class="nf">train_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">num_minibatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">loop_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define default minibatch training loop.</span>

<span class="sd">    A training loop that performs minibatching with ``num_minibatches``</span>
<span class="sd">    minibatches.</span>

<span class="sd">    Args:</span>
<span class="sd">        sess (tf.Session): Current tensorflow session.</span>
<span class="sd">        train_targets (dict): Target operations to be evaluated by ``sess.run``.</span>
<span class="sd">            By default, ``base.train_from_params`` inserts the following</span>
<span class="sd">            targets to facilitate minibatching:</span>
<span class="sd">                * ``__grads__`` (tf.Operation): Accumulates and stores gradients.</span>
<span class="sd">                * ``optimizer`` (tf.Operation): Applies and zeros gradients.</span>
<span class="sd">        num_minibatches (int): number of minibatches to use.</span>
<span class="sd">        **loop_params (mapping): additional, user-defined kwargs to</span>
<span class="sd">            be used in the training loop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing train targets evaluated by the session.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">required</span> <span class="ow">in</span> <span class="n">targets</span> <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">train_targets</span>
                <span class="k">for</span> <span class="n">required</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__grads__&#39;</span><span class="p">,</span> <span class="s1">&#39;optimizer&#39;</span><span class="p">]])</span>

    <span class="c1"># Perform minibatching</span>
    <span class="n">range_len</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">num_minibatches</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">minibatch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">range_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Accumulate gradient for each minibatch</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;__grads__&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">train_targets</span><span class="p">])</span>

    <span class="c1"># Compute final targets (includes zeroing gradient accumulator variable)</span>
    <span class="k">return</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span></div>


<div class="viewcode-block" id="train"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.train">[docs]</a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
          <span class="n">queues</span><span class="p">,</span>
          <span class="n">dbinterface</span><span class="p">,</span>
          <span class="n">train_loop</span><span class="p">,</span>
          <span class="n">train_targets</span><span class="p">,</span>
          <span class="n">global_step</span><span class="p">,</span>
          <span class="n">num_minibatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">num_steps</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span>
          <span class="n">thres_loss</span><span class="o">=</span><span class="n">DEFAULT_TRAIN_THRES_LOSS</span><span class="p">,</span>
          <span class="n">validate_first</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
          <span class="n">validation_targets</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Actually runs the training evaluation loop.</span>

<span class="sd">    :Args:</span>
<span class="sd">        - sess: (tesorflow.Session)</span>
<span class="sd">            Object in which to run calculations</span>
<span class="sd">        - queues (list of Queue)</span>
<span class="sd">            Objects containing asynchronously queued data iterators</span>
<span class="sd">        - dbinterface (DBInterface object)</span>
<span class="sd">            Saver through which to save results</span>
<span class="sd">        - train_loop (callable withs args: sess and train_targets)</span>
<span class="sd">            Callable that specifies a custom training loop</span>
<span class="sd">        - train_targets (dict of tensorflow nodes)</span>
<span class="sd">            Targets to train. One item in this dict must be &quot;optimizer&quot; or similar</span>
<span class="sd">            to make anything happen</span>
<span class="sd">        - num_minibatches (int)</span>
<span class="sd">            How many minibatches to use to before applying gradient update.</span>
<span class="sd">        - num_steps (int)</span>
<span class="sd">            How many steps to train to before quitting</span>
<span class="sd">        - validation_targets (dict of tensorflow objects, default: None)</span>
<span class="sd">            Objects on which validation will be computed</span>
<span class="sd">        - thres_loss (float, default: 100)</span>
<span class="sd">            If loss exceeds this during training, HiLossError is thrown</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Collect args in a dict of lists</span>
    <span class="n">train_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;queues&#39;</span><span class="p">:</span> <span class="n">queues</span><span class="p">,</span>
        <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="n">num_steps</span><span class="p">,</span>
        <span class="s1">&#39;thres_loss&#39;</span><span class="p">:</span> <span class="n">thres_loss</span><span class="p">,</span>
        <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="n">train_loop</span><span class="p">,</span>
        <span class="s1">&#39;global_step&#39;</span><span class="p">:</span> <span class="n">global_step</span><span class="p">,</span>
        <span class="s1">&#39;dbinterface&#39;</span><span class="p">:</span> <span class="n">dbinterface</span><span class="p">,</span>
        <span class="s1">&#39;train_targets&#39;</span><span class="p">:</span> <span class="n">train_targets</span><span class="p">,</span>
        <span class="s1">&#39;validate_first&#39;</span><span class="p">:</span> <span class="n">validate_first</span><span class="p">,</span>
        <span class="s1">&#39;num_minibatches&#39;</span><span class="p">:</span> <span class="n">num_minibatches</span><span class="p">,</span>
        <span class="s1">&#39;validation_targets&#39;</span><span class="p">:</span> <span class="n">validation_targets</span><span class="p">}</span>

    <span class="c1"># Convert to a list of dicts</span>
    <span class="n">trargs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">train_args</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_targets</span><span class="p">))]</span>

    <span class="n">num_steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trargs</span><span class="p">]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trargs</span><span class="p">]</span>

    <span class="c1"># Start queues and initial validation</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">trarg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">trargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training cancelled since step ({}) is &gt;= num_steps ({})&#39;</span><span class="o">.</span>
                     <span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]))</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training beginning ...&#39;</span><span class="p">)</span>
        <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;validate_first&#39;</span><span class="p">]:</span>
                <span class="n">valid_res</span> <span class="o">=</span> <span class="n">run_targets_dict</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span>
                                             <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;validation_targets&#39;</span><span class="p">],</span>
                                             <span class="n">dbinterface</span><span class="o">=</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">])</span>
    <span class="n">train_loop</span> <span class="o">=</span> <span class="n">train_args</span><span class="p">[</span><span class="s1">&#39;train_loop&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">train_targets</span> <span class="o">=</span> <span class="n">train_args</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]</span>

    <span class="c1"># Run training</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">num_step</span> <span class="k">for</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">num_step</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)):</span>

        <span class="n">start_time_step</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">train_results</span> <span class="o">=</span> <span class="n">train_loop</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">num_minibatches</span><span class="o">=</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;num_minibatches&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">trarg</span><span class="p">,</span> <span class="n">train_res</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">trargs</span><span class="p">,</span> <span class="n">train_results</span><span class="p">):</span>

            <span class="n">old_step</span> <span class="o">=</span> <span class="n">step</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">old_step</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoChangeError</span><span class="p">(</span><span class="s1">&#39;Your optimizer should have incremented the global step,&#39;</span>
                                    <span class="s1">&#39; but did not: old_step=</span><span class="si">%d</span><span class="s1">, new_step=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_step</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">train_res</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;thres_loss&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">HiLossError</span><span class="p">(</span><span class="s1">&#39;Loss {:.2f} exceeded the threshold {:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_res</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span>
                                                                                     <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;thres_loss&#39;</span><span class="p">]))</span>

            <span class="c1"># Validation</span>
            <span class="n">vtargs</span> <span class="o">=</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;validation_targets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">save_valid_freq</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">valid_res</span> <span class="o">=</span> <span class="n">run_targets_dict</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">vtargs</span><span class="p">)</span>

            <span class="c1"># Save</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start_time_step</span> <span class="o">=</span> <span class="n">start_time_step</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">train_res</span><span class="o">=</span><span class="n">train_res</span><span class="p">,</span>
                                      <span class="n">valid_res</span><span class="o">=</span><span class="n">valid_res</span><span class="p">,</span>
                                      <span class="n">validation_only</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">sess</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trargs</span><span class="p">]</span>

    <span class="c1"># Sync and close the session</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trarg</span> <span class="ow">in</span> <span class="n">trargs</span><span class="p">:</span>
        <span class="n">stop_queues</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;queues&#39;</span><span class="p">],</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">])</span>
        <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sync_with_host</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">outrecs</span><span class="p">)</span>

    <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="train_from_params"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.train_from_params">[docs]</a><span class="k">def</span> <span class="nf">train_from_params</span><span class="p">(</span><span class="n">save_params</span><span class="p">,</span>
                      <span class="n">model_params</span><span class="p">,</span>
                      <span class="n">train_params</span><span class="p">,</span>
                      <span class="n">loss_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">learning_rate_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">optimizer_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">validation_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">log_device_placement</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">load_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">dont_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">skip_check</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                      <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main training interface function.</span>

<span class="sd">    Args:</span>
<span class="sd">        save_params (dict): Dictionary of arguments for creating saver object (see Saver class).</span>
<span class="sd">        model_params (dict): Containing function that produces model and arguments to that function.</span>
<span class="sd">            model_params[&#39;func&#39;] is the function producing the model.</span>
<span class="sd">                The function&#39;s signature is:</span>
<span class="sd">                Args:</span>
<span class="sd">                    inputs: data object</span>
<span class="sd">                    - `train` -- boolean if training is happening</span>
<span class="sd">                    - `seed` -- seed for use in random generation of final config</span>
<span class="sd">                Returns:</span>
<span class="sd">                    (tf.Operations): train output tensorflow nodes</span>
<span class="sd">                    - final configuration used in model</span>
<span class="sd">            - Remaining items in model_params are dictionary of arguments massed to func.</span>

<span class="sd">        train_params (dict): Containing params for data sources and targets in training:</span>
<span class="sd">            - train_params[&#39;data&#39;] contains params for the data</span>
<span class="sd">                - train_params[&#39;data&#39;][&#39;func&#39;] is the function that constructs the data</span>
<span class="sd">                  provider.   This dataprovider must be an instance of a subclass of</span>
<span class="sd">                  tfutils.data.DataProviderBase.   Specifically, it must have a method</span>
<span class="sd">                  called &quot;init_ops&quot; -- see documentation in tfutils/data.py.</span>
<span class="sd">                - remainder of train_params[&#39;data&#39;] are kwargs passed to func</span>
<span class="sd">            - train_params[&#39;targets&#39;] (optional) contains params for additional train targets</span>
<span class="sd">                - train_params[&#39;targets&#39;][&#39;func&#39;] is a function that produces</span>
<span class="sd">                  tensorflow nodes as training targets</span>
<span class="sd">                - remainder of train_parms[&#39;targets&#39;] are arguments to func</span>
<span class="sd">            - train_params[&#39;queue_params&#39;] is an optional dict of</span>
<span class="sd">                  params used to specify creation for the queue, passed to the</span>
<span class="sd">                  Queue.__init__ method.   Default is {}.</span>
<span class="sd">        loss_params (dict): Parameters for to utils.get_loss function for specifying loss</span>
<span class="sd">            - loss_params[&#39;targets&#39;] is a string or a list of strings,</span>
<span class="sd">              contain the names of inputs nodes that will be sent into the loss function</span>
<span class="sd">              Must be provided</span>
<span class="sd">            - loss_params[&#39;loss_per_case_func&#39;] is the function used to calculate the loss.</span>
<span class="sd">              Must be provided.</span>
<span class="sd">              The parameters sent to this function is defined by loss_params[&#39;loss_per_case_func_params&#39;].</span>
<span class="sd">            - loss_params[&#39;loss_per_case_func_params&#39;] is a dict including  help information about</span>
<span class="sd">              how positional parameters should be sent to loss_params[&#39;loss_per_case_func&#39;] as named parameters.</span>
<span class="sd">              Default is {&#39;_outputs&#39;: &#39;logits&#39;, &#39;_targets_&#39;: &#39;labels&#39;}</span>
<span class="sd">                - If loss_params[&#39;loss_per_case_func_params&#39;] is empty, the parameters for</span>
<span class="sd">                  loss_params[&#39;loss_per_case_func&#39;] will be (outputs, *[inputs[t] for t in targets], **loss_func_kwargs),</span>
<span class="sd">                  where &#39;outputs&#39; is the output of the network, inputs is the input nodes,</span>
<span class="sd">                  and targets is loss_params[&#39;targets&#39;].</span>
<span class="sd">                - Key value can have three choices:</span>
<span class="sd">                  - &#39;_outputs&#39;: the value of this key will be the name for &#39;outputs&#39;.</span>
<span class="sd">                  - &#39;_targets_&#39;: name for &#39;[inputs[t] for t in targets]&#39;.</span>
<span class="sd">                  - &#39;_target_somename&#39;: name for &#39;inputs[somename]&#39; is somename is inside targets.</span>
<span class="sd">                - Parameters not mentioned by the key values will still be sent to the function as positional parameters.</span>
<span class="sd">            - loss_params[&#39;agg_func&#39;] is the aggregate function, default is None</span>
<span class="sd">            - loss_params[&#39;loss_func_kwargs&#39;]. Keyword parameters sent to loss_params[&#39;loss_per_case_func&#39;]. Default is None.</span>
<span class="sd">            - loss_params[&#39;agg_func_kwargs&#39;]. Keyword parameters sent to loss_params[&#39;agg_func&#39;]. Default is None.</span>

<span class="sd">        learning_rate_params (dict): Parameters for specifying learning_rate:</span>
<span class="sd">            - learning_rate_params[&#39;func&#39;] is a function producing</span>
<span class="sd">              tensorflow node acting as learning rate.</span>
<span class="sd">              This function must accept argument &quot;global_step&quot;.</span>
<span class="sd">            - remainder of learning_rate_params are arguments to func.</span>

<span class="sd">        optimizer_params (dict): Parameters for creating optimizer:</span>
<span class="sd">            - optimizer_params[&#39;func&#39;] is a function producing a</span>
<span class="sd">              tensorflow optimizer object (like a subclass of tf.train.Optimizer)</span>
<span class="sd">              - Must accept:</span>
<span class="sd">                    &quot;learning_rate&quot; -- the result of the learning_rate_func call</span>
<span class="sd">              - Must return object with a method called &quot;minimize&quot; with</span>
<span class="sd">                the same call signature as tensorflow.train.Optimizer.minimize --- that is:</span>
<span class="sd">                    - Must accept:</span>
<span class="sd">                        - &quot;loss&quot; -- result of loss_func call</span>
<span class="sd">                        - &quot;global_step&quot; -- global step used for determine learning rate,</span>
<span class="sd">                    - Must return:</span>
<span class="sd">                        - tensorflow node which computes gradients and applies</span>
<span class="sd">                          them, and must increment &quot;global_step&quot;</span>
<span class="sd">            - Remainder of optimizer_params (aside form &quot;func&quot;) are arguments</span>
<span class="sd">              to the optimizer func</span>

<span class="sd">        validation_params (dict): Dictionary of validation sources. The structure if this dictionary is:</span>
<span class="sd">            {</span>
<span class="sd">                &lt;validation_target_name_1&gt;: {</span>
<span class="sd">                    &#39;data&#39;: {</span>
<span class="sd">                        &#39;func&#39;: (callable) data source function for this validation,</span>
<span class="sd">                        &lt;kwarg1&gt;: &lt;value1&gt; for &#39;func&#39;,</span>
<span class="sd">                        ...</span>
<span class="sd">                        },</span>
<span class="sd">                    &#39;targets&#39;: {</span>
<span class="sd">                        &#39;func&#39;: (callable) returning targets,</span>
<span class="sd">                        &lt;kwarg1&gt;: &lt;value1&gt; for &#39;func&#39;,</span>
<span class="sd">                        ...</span>
<span class="sd">                        }</span>
<span class="sd">                    &#39;queue_params&#39;: (optional, dict) params for creating queue for</span>
<span class="sd">                            this validation. NB: if this is NOT specified, queue params</span>
<span class="sd">                            for this validation default to those used in constructing</span>
<span class="sd">                            the training data queue.</span>
<span class="sd">                    &#39;num_steps&#39;: (int) number of batches of validation source to compute</span>
<span class="sd">                    &#39;agg_func&#39;: (optional, callable) how to aggregate validation results</span>
<span class="sd">                            across batches after computation. Signature is:</span>
<span class="sd">                                - one input argument: the list of validation batch results</span>
<span class="sd">                                - one output: aggregated version</span>
<span class="sd">                            Default is utils.identity_func</span>
<span class="sd">                    &#39;online_agg_func&#39;: (optional, callable) how to aggregate validation results</span>
<span class="sd">                            on a per-batch basis. Siganture is:</span>
<span class="sd">                                - three input arguments: (current aggregate, new result, step)</span>
<span class="sd">                                - one output: new aggregated result</span>
<span class="sd">                            One first step, current aggregate passed in is None.</span>
<span class="sd">                            The final result is passed to the &quot;agg_func&quot;.</span>
<span class="sd">                            Default is utils.append_and_return</span>
<span class="sd">                },</span>
<span class="sd">                &lt;validation_target_name_2&gt;: ...</span>
<span class="sd">            }</span>

<span class="sd">        For each validation_target_name key, the targets are computed and then added to</span>
<span class="sd">        the output dictionary to be computed every so often -- unlike train_targets which</span>
<span class="sd">        are computed on each time step, these are computed on a basic controlled by the</span>
<span class="sd">        valid_save_freq specific in the saver_params.</span>

<span class="sd">        queue_params (dict, defualt: None): Dictionary of arguments to Queue object (see</span>
<span class="sd">            tfutils.data.Queue documentation)</span>

<span class="sd">        thres_loss (float, default: 100): If loss exceeds this during training, HiLossError is thrown</span>

<span class="sd">        num_steps (int or None, default: None): How many total steps of the optimization are run.</span>
<span class="sd">            If None, train is run until process is cancelled.</span>

<span class="sd">        load_params (dict): Dictionary of arguments for loading model, if different from saver</span>
<span class="sd">            (see Saver class).</span>

<span class="sd">        log_device_placement (bool, default: False): Whether to log device placement in tensorflow session</span>

<span class="sd">        inter_op_parallelism_threads (int, default: 40): Inter op thread pool size (has to be set large enough to avoid deadlock</span>
<span class="sd">            when using multiple queues)</span>

<span class="sd">    Deleted Parameters:</span>
<span class="sd">        saver_params</span>

<span class="sd">    Returns:</span>
<span class="sd">        TYPE: Description.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">train_args</span> <span class="o">=</span> <span class="n">parse_params</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                      <span class="n">model_params</span><span class="p">,</span>
                                      <span class="n">dont_run</span><span class="o">=</span><span class="n">dont_run</span><span class="p">,</span>
                                      <span class="n">skip_check</span><span class="o">=</span><span class="n">skip_check</span><span class="p">,</span>
                                      <span class="n">load_params</span><span class="o">=</span><span class="n">load_params</span><span class="p">,</span>
                                      <span class="n">loss_params</span><span class="o">=</span><span class="n">loss_params</span><span class="p">,</span>
                                      <span class="n">save_params</span><span class="o">=</span><span class="n">save_params</span><span class="p">,</span>
                                      <span class="n">train_params</span><span class="o">=</span><span class="n">train_params</span><span class="p">,</span>
                                      <span class="n">optimizer_params</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">,</span>
                                      <span class="n">validation_params</span><span class="o">=</span><span class="n">validation_params</span><span class="p">,</span>
                                      <span class="n">learning_rate_params</span><span class="o">=</span><span class="n">learning_rate_params</span><span class="p">,</span>
                                      <span class="n">log_device_placement</span><span class="o">=</span><span class="n">log_device_placement</span><span class="p">,</span>
                                      <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="n">inter_op_parallelism_threads</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEFAULT_HOST</span><span class="p">):</span>

        <span class="c1"># For convenience, use list of dicts instead of dict of lists</span>
        <span class="n">_params</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]))]</span>
        <span class="n">_trargs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">train_args</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]))]</span>

        <span class="c1"># Use a single dataprovider for all models.</span>
        <span class="n">data_params</span> <span class="o">=</span> <span class="n">_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
        <span class="n">queue_params</span> <span class="o">=</span> <span class="n">_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;queue_params&#39;</span><span class="p">]</span>

        <span class="p">(</span><span class="n">_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;data_params&#39;</span><span class="p">],</span>
         <span class="n">queues</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">queue_params</span><span class="o">=</span><span class="n">queue_params</span><span class="p">,</span> <span class="o">**</span><span class="n">data_params</span><span class="p">)</span>

        <span class="c1"># Build a graph for each distinct model.</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trarg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span> <span class="n">_trargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]):</span>

                <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;global_step&#39;</span><span class="p">,</span> <span class="p">[],</span>
                                                       <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                       <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">trarg</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span>
                                               <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">],</span>
                                               <span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
                                               <span class="n">trarg</span><span class="o">=</span><span class="n">trarg</span><span class="p">)</span>

                <span class="n">tf</span><span class="o">.</span><span class="n">get_variable_scope</span><span class="p">()</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>

                <span class="p">(</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;validation_targets&#39;</span><span class="p">],</span>
                 <span class="n">vqueue</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_valid_targets_dict</span><span class="p">(</span><span class="n">queue_params</span><span class="o">=</span><span class="n">queue_params</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">param</span><span class="p">)</span>
                <span class="n">queues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vqueue</span><span class="p">)</span>

        <span class="c1"># Create session.</span>

        <span class="c1"># gpu_options = tf.GPUOptions(per_process_gpu_memory_fraction=0.5)</span>
        <span class="n">gpu_options</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GPUOptions</span><span class="p">(</span><span class="n">allow_growth</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">(</span><span class="n">allow_soft_placement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">gpu_options</span><span class="o">=</span><span class="n">gpu_options</span><span class="p">,</span>
                                                <span class="n">log_device_placement</span><span class="o">=</span><span class="n">log_device_placement</span><span class="p">,</span>
                                                <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="n">inter_op_parallelism_threads</span><span class="p">))</span>

        <span class="n">init_op_global</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_global</span><span class="p">)</span>
        <span class="n">init_op_local</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">local_variables_initializer</span><span class="p">()</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op_local</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initialized from scratch first&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trarg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_params</span><span class="p">,</span> <span class="n">_trargs</span><span class="p">):</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">][</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">all_vars</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">_all_saveable_objects</span><span class="p">()</span>
            <span class="n">var_list</span> <span class="o">=</span> <span class="n">strip_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DBInterface</span><span class="p">(</span><span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span>
                                               <span class="n">params</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
                                               <span class="n">var_list</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
                                               <span class="n">global_step</span><span class="o">=</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">],</span>
                                               <span class="n">save_params</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">],</span>
                                               <span class="n">load_params</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;load_params&#39;</span><span class="p">])</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;dbinterface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;queues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">queues</span>

        <span class="c1"># Convert back to a dictionary of lists</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">_params</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">train_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">trarg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">trarg</span> <span class="ow">in</span> <span class="n">_trargs</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_trargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">dont_run</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">train_args</span>

        <span class="k">return</span> <span class="n">train</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="o">**</span><span class="n">train_args</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_valid_targets_dict"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_valid_targets_dict">[docs]</a><span class="k">def</span> <span class="nf">get_valid_targets_dict</span><span class="p">(</span><span class="n">validation_params</span><span class="p">,</span>
                           <span class="n">model_params</span><span class="p">,</span>
                           <span class="n">loss_params</span><span class="p">,</span>
                           <span class="n">queue_params</span><span class="p">,</span>
                           <span class="n">cfg_final</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function for creating validation target operations.</span>

<span class="sd">    NB: this function may modify validation_params.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_targets_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">queues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="c1"># model_params.pop(&#39;train&#39;, None)  # hackety-hack</span>
    <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg_final</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s1">&#39;cfg_final&#39;</span> <span class="ow">in</span> <span class="n">model_params</span>
        <span class="n">cfg_final</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s1">&#39;seed&#39;</span> <span class="ow">in</span> <span class="n">model_params</span>
    <span class="k">for</span> <span class="n">vtarg</span> <span class="ow">in</span> <span class="n">validation_params</span><span class="p">:</span>
        <span class="n">queue_params</span> <span class="o">=</span> <span class="n">validation_params</span><span class="p">[</span><span class="n">vtarg</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;queue_params&#39;</span><span class="p">,</span> <span class="n">queue_params</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">vinputs</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">queue_params</span><span class="o">=</span><span class="n">queue_params</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">validation_params</span><span class="p">[</span><span class="n">vtarg</span><span class="p">][</span><span class="s1">&#39;data_params&#39;</span><span class="p">])</span>
        <span class="n">queues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="c1"># scope_name = &#39;validation/%s&#39; % vtarg</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="s1">&#39;{}/validation/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">vtarg</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
            <span class="n">_mp</span><span class="p">,</span> <span class="n">voutputs</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">vinputs</span><span class="p">,</span> <span class="n">model_params</span><span class="p">)</span>
            <span class="n">check_model_equivalence</span><span class="p">(</span><span class="n">_mp</span><span class="p">[</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">],</span> <span class="n">cfg_final</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">get_variable_scope</span><span class="p">()</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>
        <span class="n">validation_params</span><span class="p">[</span><span class="n">vtarg</span><span class="p">],</span> <span class="n">valid_targets_dict</span><span class="p">[</span><span class="n">vtarg</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_validation_target</span><span class="p">(</span><span class="n">vinputs</span><span class="p">,</span> <span class="n">voutputs</span><span class="p">,</span>
                                                                                    <span class="o">**</span><span class="n">validation_params</span><span class="p">[</span><span class="n">vtarg</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">valid_targets_dict</span><span class="p">,</span> <span class="n">queues</span></div>


<div class="viewcode-block" id="check_model_equivalence"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.check_model_equivalence">[docs]</a><span class="k">def</span> <span class="nf">check_model_equivalence</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TODO: fill this in to make it stronger.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">m2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="get_validation_target"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_validation_target">[docs]</a><span class="k">def</span> <span class="nf">get_validation_target</span><span class="p">(</span><span class="n">vinputs</span><span class="p">,</span> <span class="n">voutputs</span><span class="p">,</span>
                          <span class="n">default_target_func</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_loss_dict</span><span class="p">,</span>
                          <span class="n">default_target_params</span><span class="o">=</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">,</span>
                          <span class="n">default_loop_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">default_loop_params</span><span class="o">=</span><span class="n">DEFAULT_LOOP_PARAMS</span><span class="p">,</span>
                          <span class="n">agg_func</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">identity_func</span><span class="p">,</span>
                          <span class="n">online_agg_func</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">append_and_return</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">validation_params</span><span class="p">):</span>
    <span class="n">target_params</span> <span class="o">=</span> <span class="n">validation_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;targets&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_target_params</span><span class="p">))</span>
    <span class="n">target_func</span> <span class="o">=</span> <span class="n">target_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">default_target_func</span><span class="p">)</span>
    <span class="n">vtargets</span> <span class="o">=</span> <span class="n">target_func</span><span class="p">(</span><span class="n">vinputs</span><span class="p">,</span> <span class="n">voutputs</span><span class="p">,</span> <span class="o">**</span><span class="n">target_params</span><span class="p">)</span>
    <span class="n">target_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_func</span>
    <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_params</span>

    <span class="n">valid_loop_params</span> <span class="o">=</span> <span class="n">validation_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;valid_loop&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_loop_params</span><span class="p">))</span>
    <span class="n">valid_loop_func</span> <span class="o">=</span> <span class="n">valid_loop_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">default_loop_func</span><span class="p">)</span>
    <span class="n">valid_loop</span> <span class="o">=</span> <span class="n">valid_loop_func</span>
    <span class="n">valid_loop_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_loop_func</span>
    <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;valid_loop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_loop_params</span>

    <span class="k">if</span> <span class="s1">&#39;num_steps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validation_params</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vinputs</span><span class="p">,</span> <span class="s1">&#39;total_batches&#39;</span><span class="p">),</span> <span class="s1">&#39;&quot;num_batches&quot; not specified in validation params, &#39;</span>\
            <span class="s1">&#39;data object must have &quot;total_batches&quot; attribute to be used as default.&#39;</span>
        <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vinputs</span><span class="o">.</span><span class="n">total_batches</span>
    <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;agg_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_func</span>
    <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;online_agg_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">online_agg_func</span>
    <span class="n">valid_targets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">vtargets</span><span class="p">,</span>
                     <span class="s1">&#39;valid_loop&#39;</span><span class="p">:</span> <span class="n">valid_loop</span><span class="p">,</span>
                     <span class="s1">&#39;agg_func&#39;</span><span class="p">:</span> <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;agg_func&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;online_agg_func&#39;</span><span class="p">:</span> <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;online_agg_func&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="n">validation_params</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">validation_params</span><span class="p">,</span> <span class="n">valid_targets</span></div>


<div class="viewcode-block" id="get_data"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_data">[docs]</a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">queue_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">data_params</span><span class="p">):</span>
    <span class="n">data_provider</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">data_params</span><span class="p">)</span>
    <span class="n">input_ops</span> <span class="o">=</span> <span class="n">data_provider</span><span class="o">.</span><span class="n">init_ops</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ops</span><span class="p">)</span> <span class="o">==</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;n_threads&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ops</span><span class="p">),</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;n_threads&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ops</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
    <span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="n">enqueue_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">get_queue</span><span class="p">(</span><span class="n">input_ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape_flag</span><span class="o">=</span><span class="n">batch_size</span><span class="o">!=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">queue_params</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">input_op</span> <span class="ow">in</span> <span class="n">input_ops</span><span class="p">:</span>
        <span class="c1"># enqueue_ops.append(queue.enqueue_many(input_op))</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">enqueue_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">input_op</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enqueue_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">enqueue_many</span><span class="p">(</span><span class="n">input_op</span><span class="p">))</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">queue_runner</span><span class="o">.</span><span class="n">add_queue_runner</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">queue_runner</span><span class="o">.</span><span class="n">QueueRunner</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span>
                                                                             <span class="n">enqueue_ops</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">queue_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">dequeue_many</span><span class="p">(</span><span class="n">queue_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data_params</span><span class="p">,</span> <span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">inputs</span></div>


<div class="viewcode-block" id="split_input"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.split_input">[docs]</a><span class="k">def</span> <span class="nf">split_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_gpus</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">n_gpus</span> <span class="o">=</span> <span class="n">num_gpus</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_gpus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_gpus</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_gpus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]</span>

    <span class="n">temp_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_or_size_splits</span><span class="o">=</span><span class="n">num_gpus</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">}</span>

    <span class="n">list_of_args</span> <span class="o">=</span> <span class="p">[{</span><span class="n">now_arg</span><span class="p">:</span> <span class="n">temp_args</span><span class="p">[</span><span class="n">now_arg</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">now_arg</span> <span class="ow">in</span> <span class="n">temp_args</span><span class="p">}</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n_gpus</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">list_of_args</span></div>


<div class="viewcode-block" id="get_model_base"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_model_base">[docs]</a><span class="k">def</span> <span class="nf">get_model_base</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">):</span>
    <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>
    <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span>
    <span class="n">outputs</span><span class="p">,</span> <span class="n">cfg_final</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
    <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;cfg_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg_final</span>
    <span class="k">return</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">outputs</span></div>


<div class="viewcode-block" id="get_model"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_model">[docs]</a><span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">trarg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return model and any other targets (loss + optimizer) specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        inputs (tf.Operation): Model inputs provided by a tf.QueueRunner.</span>
<span class="sd">        model_params (dict): Specifies model configuration and must contain:</span>
<span class="sd">            &#39;devices&#39; (list): device specs (e.g. &#39;/gpu:0&#39;)</span>
<span class="sd">            &#39;train&#39; (bool): whether getting model for training</span>
<span class="sd">        param (None, optional): Description.</span>
<span class="sd">        trarg (None, optional): Description.</span>
<span class="sd">        inputs ()</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: Description.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable_scope</span><span class="p">()):</span>

        <span class="n">tower_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]</span>
        <span class="n">num_gpus</span> <span class="o">=</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">split_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">num_gpus</span><span class="p">)</span>
        <span class="c1"># DEFAULT: Prepare loss and optimizer if training.</span>
        <span class="k">if</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">trarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

            <span class="n">tower_losses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tower_grads</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">],</span>
             <span class="n">learning_rate</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_learning_rate</span><span class="p">(</span><span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">],</span>
                                                <span class="o">**</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;learning_rate_params&#39;</span><span class="p">])</span>
            <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">],</span>
             <span class="n">optimizer_base</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_optimizer_base</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span>
                                                  <span class="n">param</span><span class="p">[</span><span class="s1">&#39;optimizer_params&#39;</span><span class="p">])</span>

        <span class="c1"># Distribute graph across desired devices.</span>
        <span class="k">for</span> <span class="n">device</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;__GPU__&#39;</span> <span class="o">+</span> <span class="n">device</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>

                <span class="n">model_params</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">get_model_base</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
                <span class="n">tower_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

                <span class="n">tf</span><span class="o">.</span><span class="n">get_variable_scope</span><span class="p">()</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>

                <span class="c1"># DEFAULT: Get loss and optimizer if training</span>
                <span class="k">if</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]:</span>

                    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">],</span>
                     <span class="n">loss</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_loss</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">])</span>

                    <span class="n">tf</span><span class="o">.</span><span class="n">get_variable_scope</span><span class="p">()</span><span class="o">.</span><span class="n">reuse_variables</span><span class="p">()</span>

                    <span class="n">grad</span> <span class="o">=</span> <span class="n">optimizer_base</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                    <span class="n">tower_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                    <span class="n">tower_grads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>

    <span class="c1"># Gather and aggregate outputs on the host (CPU).</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">aggregate_outputs</span><span class="p">(</span><span class="n">tower_outputs</span><span class="p">)</span>

    <span class="c1"># DEFAULT: Accumulate and average gradients on the host (CPU).</span>
    <span class="k">if</span> <span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;targets&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ttargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">][</span><span class="s1">&#39;targets&#39;</span><span class="p">])</span>
            <span class="n">ttargs_func</span> <span class="o">=</span> <span class="n">ttargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">)</span>
            <span class="n">ttarg</span> <span class="o">=</span> <span class="n">ttargs_func</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">ttargs</span><span class="p">)</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ttarg</span><span class="p">)</span>

        <span class="c1"># Aggregate loss.</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tower_losses</span><span class="p">))</span>

        <span class="c1"># Aggregate and accumulate gradients.</span>
        <span class="n">minibatch_grads</span> <span class="o">=</span> <span class="n">optimizer_base</span><span class="o">.</span><span class="n">aggregate_gradients</span><span class="p">(</span><span class="n">tower_grads</span><span class="p">)</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">optimizer_base</span><span class="o">.</span><span class="n">accumulate_gradients</span><span class="p">(</span><span class="n">minibatch_grads</span><span class="p">,</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;num_minibatches&#39;</span><span class="p">])</span>

        <span class="c1"># Apply accumulated gradients.</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_base</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;global_step&#39;</span><span class="p">])</span>

        <span class="c1"># Prepare train_targets</span>
        <span class="k">if</span> <span class="s1">&#39;loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]:</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">][</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="k">if</span> <span class="s1">&#39;__grads__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]:</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">][</span><span class="s1">&#39;__grads__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grads</span>
        <span class="k">if</span> <span class="s1">&#39;optimizer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]:</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">][</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="k">if</span> <span class="s1">&#39;learning_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">]:</span>
            <span class="n">trarg</span><span class="p">[</span><span class="s1">&#39;train_targets&#39;</span><span class="p">][</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate</span>

        <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_params</span>
        <span class="k">return</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">],</span> <span class="n">output</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">trarg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">output</span></div>


<div class="viewcode-block" id="get_loss"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_loss">[docs]</a><span class="k">def</span> <span class="nf">get_loss</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span>
             <span class="n">train_outputs</span><span class="p">,</span>
             <span class="n">targets</span><span class="o">=</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">],</span>
             <span class="n">agg_func</span><span class="o">=</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">[</span><span class="s1">&#39;agg_func&#39;</span><span class="p">],</span>
             <span class="n">loss_per_case_func</span><span class="o">=</span><span class="n">DEFAULT_LOSS_PARAMS</span><span class="p">[</span><span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">],</span>
             <span class="o">**</span><span class="n">loss_params</span><span class="p">):</span>
    <span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targets</span>
    <span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;agg_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_func</span>
    <span class="n">loss_params</span><span class="p">[</span><span class="s1">&#39;loss_per_case_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_per_case_func</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_outputs</span><span class="p">,</span> <span class="o">**</span><span class="n">loss_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss_params</span><span class="p">,</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="get_learning_rate"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_learning_rate">[docs]</a><span class="k">def</span> <span class="nf">get_learning_rate</span><span class="p">(</span><span class="n">global_step</span><span class="p">,</span>
                      <span class="n">func</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">exponential_decay</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">learning_rate_params</span><span class="p">):</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">learning_rate_params</span><span class="p">)</span>
    <span class="n">learning_rate_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">learning_rate_params</span><span class="p">,</span> <span class="n">learning_rate</span></div>


<div class="viewcode-block" id="get_optimizer"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_optimizer">[docs]</a><span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span>
                  <span class="n">loss</span><span class="p">,</span>
                  <span class="n">global_step</span><span class="p">,</span>
                  <span class="n">optimizer_params</span><span class="p">,</span>
                  <span class="n">default_optimizer_params</span><span class="o">=</span><span class="n">DEFAULT_OPTIMIZER_PARAMS</span><span class="p">,</span>
                  <span class="n">default_optimizer_func</span><span class="o">=</span><span class="n">ClipOptimizer</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">optimizer_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">optimizer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_optimizer_params</span><span class="p">)</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">optimizer_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">default_optimizer_func</span><span class="p">)</span>
    <span class="n">optimizer_base</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">optimizer_params</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_base</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">global_step</span><span class="p">)</span>
    <span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">optimizer_params</span><span class="p">,</span> <span class="n">optimizer</span></div>


<div class="viewcode-block" id="get_optimizer_base"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_optimizer_base">[docs]</a><span class="k">def</span> <span class="nf">get_optimizer_base</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span>
                       <span class="n">optimizer_params</span><span class="p">,</span>
                       <span class="n">default_optimizer_params</span><span class="o">=</span><span class="n">DEFAULT_OPTIMIZER_PARAMS</span><span class="p">,</span>
                       <span class="n">default_optimizer_func</span><span class="o">=</span><span class="n">ClipOptimizer</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">optimizer_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">optimizer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_optimizer_params</span><span class="p">)</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">optimizer_params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">default_optimizer_func</span><span class="p">)</span>
    <span class="n">optimizer_base</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">optimizer_params</span><span class="p">)</span>
    <span class="n">optimizer_params</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">optimizer_params</span><span class="p">,</span> <span class="n">optimizer_base</span></div>


<div class="viewcode-block" id="get_params"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.get_params">[docs]</a><span class="k">def</span> <span class="nf">get_params</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--params&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--gpu&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_func&#39;</span><span class="p">),</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">modname</span><span class="p">,</span> <span class="n">objname</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">objname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span></div>


<div class="viewcode-block" id="parse_params"><a class="viewcode-back" href="../../tfutils.html#tfutils.base.parse_params">[docs]</a><span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span>
                 <span class="n">model_params</span><span class="p">,</span>
                 <span class="n">dont_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">skip_check</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">save_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">train_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">loss_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">load_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">optimizer_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">validation_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">learning_rate_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">log_device_placement</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">inter_op_parallelism_threads</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                 <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure the params dictionary has the correct structure.</span>

<span class="sd">    Each *_params arg must be a list of dictionaries where the ith element</span>
<span class="sd">    corresponds to parameters of the ith distinct model. Thus, the length of</span>
<span class="sd">    all *_params must be the same and reflect the number of distinct models</span>
<span class="sd">    to be evaluated.</span>

<span class="sd">    If an *_params arg does not satisfy the above requirements, ``parse_params``</span>
<span class="sd">    attempts to convert to the correct structure and logs any changes made.</span>
<span class="sd">    If it is missing any necessary components, defaults defined at the top of</span>
<span class="sd">    this module are used. If there exists an unresovlable conflict, an error</span>
<span class="sd">    is raised, and the user will be forced to resolve it before continuing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_params</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span>
                                                    <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">model_params</span>
    <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
    <span class="n">list_lens</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_models</span><span class="p">]</span>
    <span class="n">DEVICES</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DEFAULT_DEVICES</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;dont_run&#39;</span><span class="p">:</span> <span class="n">dont_run</span><span class="p">,</span>
        <span class="s1">&#39;skip_check&#39;</span><span class="p">:</span> <span class="n">skip_check</span><span class="p">,</span>
        <span class="s1">&#39;load_params&#39;</span><span class="p">:</span> <span class="n">load_params</span><span class="p">,</span>
        <span class="s1">&#39;save_params&#39;</span><span class="p">:</span> <span class="n">save_params</span><span class="p">,</span>
        <span class="s1">&#39;model_params&#39;</span><span class="p">:</span> <span class="n">model_params</span><span class="p">,</span>
        <span class="s1">&#39;validation_params&#39;</span><span class="p">:</span> <span class="n">validation_params</span><span class="p">,</span>
        <span class="s1">&#39;log_device_placement&#39;</span><span class="p">:</span> <span class="n">log_device_placement</span><span class="p">,</span>
        <span class="s1">&#39;inter_op_parallelism_threads&#39;</span><span class="p">:</span> <span class="n">inter_op_parallelism_threads</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;loss_params&#39;</span><span class="p">:</span> <span class="n">loss_params</span><span class="p">,</span>
            <span class="s1">&#39;train_params&#39;</span><span class="p">:</span> <span class="n">train_params</span><span class="p">,</span>
            <span class="s1">&#39;optimizer_params&#39;</span><span class="p">:</span> <span class="n">optimizer_params</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate_params&#39;</span><span class="p">:</span> <span class="n">learning_rate_params</span><span class="p">})</span>

    <span class="c1"># Ensure params is a dict of lists, using defaults when necessary.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param_list</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">DEFAULT_PARAMS</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">frozendict</span><span class="p">):</span>
                <span class="n">param_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DEFAULT_PARAMS</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_list</span> <span class="o">=</span> <span class="n">DEFAULT_PARAMS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_models</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">param_list</span> <span class="o">+=</span> <span class="p">(</span><span class="n">num_models</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_num</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>

            <span class="c1"># Parse model_params.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;model_params&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;seed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_MODEL_SEED</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No seed specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting to seed: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_MODEL_SEED</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;prefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;model_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No prefix specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting to prefix: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                        <span class="n">param</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">param</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="c1"># Parse device specification.</span>
                <span class="k">if</span> <span class="s1">&#39;devices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEVICES</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No devices specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting to gpus: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]))</span>
                <span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_devices</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="s1">&#39;num_gpus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]),</span> <span class="p">(</span>
                       <span class="s1">&#39;num_gpus does not match the number of gpus specified in devices.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_gpus&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]),</span> <span class="p">(</span>
                       <span class="s1">&#39;num_gpus does not match the number of gpus specified in devices.&#39;</span><span class="p">)</span>

            <span class="c1"># Parse train_params.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;train_params&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;num_steps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_TRAIN_NUM_STEPS</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;num_steps not specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting num_steps to: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_TRAIN_NUM_STEPS</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;thres_loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;thres_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_TRAIN_THRES_LOSS</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;thres_loss not specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting thres_loss to: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DEFAULT_TRAIN_THRES_LOSS</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;train_loop&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;train_loop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">train_loop</span><span class="p">}</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;train_loop not specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Using default training loop.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;validate_first&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;validate_first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validate_fist not specified for model {}... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_num</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting validate_first to: {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;validate_first&#39;</span><span class="p">]))</span>

                <span class="c1"># Parse training data params (minibatching).</span>
                <span class="k">if</span> <span class="s1">&#39;minibatch_size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_minibatches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;minibatch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;minibatch_size not specified for training data_params... &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;Defaulting minibatch_size to: {} (identical to the batch size).&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
                    <span class="n">minibatch_size</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;minibatch_size&#39;</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">minibatch_size</span> <span class="o">&lt;=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="p">(</span>
                           <span class="s1">&#39;Minibatch size cannot be larger than batch size.&#39;</span><span class="p">)</span>

                    <span class="n">num_minibatches</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">minibatch_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_minibatches</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">num_minibatches</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">num_minibatches</span><span class="p">)</span>
                        <span class="n">minibatch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="n">num_minibatches</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Minibatch size ({}) does not divide batch size ({}) evenly...&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minibatch_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">))</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Rounding minibatch size to closest factor of batch size: {}&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minibatch_size</span><span class="p">))</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;minibatch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minibatch_size</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;num_minibatches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_minibatches</span>
                    <span class="n">param</span><span class="p">[</span><span class="s1">&#39;queue_params&#39;</span><span class="p">][</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minibatch_size</span>

        <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_list</span>

        <span class="n">list_lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s1">&#39;{} should also be a list&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_models</span><span class="p">,</span> <span class="s1">&#39;{} should have length&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_models</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">list_lens</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;All param lists should have be same length!&#39;</span>

    <span class="c1"># Append the model_prefix to non-unique exp_ids.</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;save_params&#39;</span><span class="p">,</span> <span class="s1">&#39;load_params&#39;</span><span class="p">]:</span>
        <span class="n">unique_exp_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_exp_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_exp_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">num_models</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Non-unique exp_ids detected in {} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39;with multiple models.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_params&#39;</span><span class="p">])):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;exp_id&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]})</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Appending </span><span class="se">\&#39;</span><span class="s1">_{} to the exp_id of model number {}.&#39;</span><span class="o">.</span>
                             <span class="n">format</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New exp_id is: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exp_id&#39;</span><span class="p">)))</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;exp_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span> <span class="o">==</span> <span class="n">num_models</span>

<span class="c1"># Prepare run_args to be passed to `base.(train|test)(**run_args)`.</span>
    <span class="n">run_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;queues&#39;</span><span class="p">:</span> <span class="n">num_models</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span>
        <span class="s1">&#39;dbinterface&#39;</span><span class="p">:</span> <span class="n">num_models</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span>
        <span class="s1">&#39;validation_targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">)]}</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
        <span class="n">run_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;save_intermediate_freq&#39;</span><span class="p">:</span> <span class="n">num_models</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">run_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;global_step&#39;</span><span class="p">:</span> <span class="n">num_models</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">],</span>
            <span class="s1">&#39;train_targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">)],</span>
            <span class="s1">&#39;num_steps&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;num_steps&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;thres_loss&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;thres_loss&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;train_loop&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;train_loop&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;validate_first&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;validate_first&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;num_minibatches&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;num_minibatches&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train_params&#39;</span><span class="p">]]})</span>

    <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">run_args</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Something like this could be used to create and save variables</span>
<span class="sd">in a readable format.</span>
<span class="sd">    def save_variables_to_readable_format():</span>
<span class="sd">        Vars = tf.all_variables()</span>
<span class="sd">        tmp = int(time.time())</span>
<span class="sd">        for v in Vars:</span>
<span class="sd">        sdir = &#39;/home/yamins/.tfutils/%d&#39; % tmp</span>
<span class="sd">        if not os.path.isdir(sdir):</span>
<span class="sd">            os.makedirs(sdir)</span>
<span class="sd">            pth = os.path.join(sdir, v.name.replace(&#39;/&#39;, &#39;__&#39;))</span>
<span class="sd">            val = v.eval(session=self.sess)</span>
<span class="sd">            np.save(pth, val)</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, NeuroAILab.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>